<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D AI 助手</title>
    <script src="./js/live2dcubismcore.min.js"></script>
    <script src="./js/live2d.min.js"></script>
    <script src="./js/pixi.min.js"></script>
    <script src="./js/cubism4.min.js"></script>
    <script src="./js/jquery-3.1.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-color: #FFFFFF;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.5s, background-image 0.5s;
        }
        #control {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 90vh;
            overflow-y: auto;
            width: 320px;
            z-index: 1000;
        }
        .section {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        #control label, #control input, #control select, #control button {
            margin: 5px 0;
            display: block;
        }
        #control input[type="text"],
        #control input[type="url"],
        #control input[type="search"],
        #control select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #control button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #control button:hover {
            background: #45a049;
        }
        #control button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #text_talk {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }
        .model-config {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            align-items: center;
        }
        .chat-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .chat-input input {
            flex: 1;
        }
        .audio-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .tts-settings {
            margin-top: 10px;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        #audio-status {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .bg-option {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .bg-input-group {
            margin-top: 10px;
        }
        #bg_type {
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 10px;
        }
        .tab {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px 4px 0 0;
            background: #f5f5f5;
        }
        .tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #bg_image_preset {
            width: 100%;
            margin-bottom: 10px;
        }
        .dialog {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .dialog-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        .secondary-button {
            background-color: #6c757d;
            color: white;
        }

        .dialog-actions {
            margin-top: 15px;
            text-align: right;
        }

        /* 新增：口型同步控制样式 */
        .lipsync-settings {
            margin-top: 5px;
        }

        .control-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            flex: 0 0 120px;
        }

        .control-group input[type="range"] {
            flex: 1;
        }

        .control-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            display: inline-block;
        }

        #mouth-value {
            min-width: 30px;
            text-align: right;
        }

        /* 美化范围滑块 */
        input[type="range"] {
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }

        /* 语音识别相关样式 */
        #voice_input {
            background-color: #4CAF50;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #voice_input:hover {
            background-color: #45a049;
        }

        #voice_input.recording {
            background-color: #f44336;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .voice-recognition-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            margin-bottom: 5px;
        }

        .voice-wave span {
            display: inline-block;
            width: 3px;
            height: 5px;
            margin: 0 2px;
            background-color: #4CAF50;
            border-radius: 1px;
            animation: wave 1s infinite ease-in-out;
        }

        .voice-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .voice-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .voice-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .voice-wave span:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes wave {
            0%, 100% { height: 5px; }
            50% { height: 20px; }
        }

        .voice-text {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="background"></div>
    <canvas id="canvas"></canvas>

    <div id="control">
        <div class="section">
            <div class="section-title">模型控制</div>
            <div class="model-selection">
                <label for="model_list">选择模型:</label>
                <select id="model_list">
                    <option value="March 7th">March 7th</option>
                    <option value="kei_vowels_pro">kei_vowels_pro</option>
                    <option value="Nova - F">Nova - F</option>
                    <option value="Hiyori">Hiyori</option>
                    <option value="pachan">pachan</option>
                    <option value="EVA RIN normal">EVA RIN normal</option>
                </select>
                <button id="update_model">更新模型</button>
                <button id="check_lfs" class="secondary-button">检查模型文件</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">语音设置</div>
            <div class="tabs">
                <div class="tab active" data-tab="tts">语音合成</div>
                <div class="tab" data-tab="stt">语音识别</div>
            </div>

            <div class="tab-content active" id="tts-tab">
                <div class="tts-settings">
                    <select id="voice_selection">
                        <option value="21m00Tcm4TlvDq8ikWAM">chinese (中文)</option>
                        <option value="AZnzlk1XvdvUeBnXmlld">Endlish (英语)</option>
                    </select>
                    <div class="volume-control">
                        <label for="volume">音量:</label>
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="0.7">
                        <span id="volume-value">70%</span>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="stt-tab">
                <div class="voice-recognition-settings">
                    <div class="control-group">
                        <label for="voice_recognition_enabled">启用语音识别:</label>
                        <input type="checkbox" id="voice_recognition_enabled" checked>
                    </div>
                    <div class="control-group">
                        <label for="voice_recognition_mode">识别模式:</label>
                        <select id="voice_recognition_mode">
                            <option value="server">服务器模式 (高精度)</option>
                            <option value="browser">浏览器模式 (低延迟)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="voice_recognition_language">语言:</label>
                        <select id="voice_recognition_language">
                            <option value="zh">中文</option>
                            <option value="en">英语</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="auto_send_voice">自动发送:</label>
                        <input type="checkbox" id="auto_send_voice" checked>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">口型同步设置</div>
            <div class="lipsync-settings">
                <div class="control-group">
                    <label for="lipsync_enabled">启用口型同步:</label>
                    <input type="checkbox" id="lipsync_enabled" checked>
                </div>
                <div class="control-group">
                    <label for="mouth_intensity">嘴巴开合强度:</label>
                    <input type="range" id="mouth_intensity" min="0.5" max="2.5" step="0.1" value="1.5">
                    <span id="mouth-value">1.5</span>
                </div>
                <div class="control-group">
                    <label for="blink_frequency">眨眼频率:</label>
                    <select id="blink_frequency">
                        <option value="high">高频率</option>
                        <option value="medium" selected>中频率</option>
                        <option value="low">低频率</option>
                        <option value="none">不眨眼</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Ollama 配置</div>
            <div class="model-config">
                <label for="llm_model">语言模型:</label>
                <select id="llm_model">
                    <option value="deepseek-r1:7b">deepseek-r1:7b</option>
                    <option value="qwen2:0.5b">Qwen2 0.5B</option>
                    <option value="llama2:7b">LLaMA2 7B</option>
                </select>

                <label for="temperature">温度:</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">

                <label for="top_p">Top P:</label>
                <input type="range" id="top_p" min="0" max="1" step="0.1" value="0.9">
            </div>
        </div>

        <div class="section">
            <div class="section-title">角色设定</div>
            <label for="role_prompt">角色设定:</label>
            <textarea id="role_prompt" rows="3" style="width: 100%">一个AI助手，会认真回答您的问题。</textarea>
        </div>

        <div class="section">
            <div class="section-title">对话</div>
            <div class="chat-container">
                <textarea id="text_talk" readonly placeholder="对话历史将显示在这里..."></textarea>
                <div class="chat-input">
                    <input type="text" id="user_input" placeholder="输入您的问题...">
                    <button id="voice_input" title="语音输入"><i class="fa fa-microphone"></i></button>
                    <button id="send_message">发送</button>
                </div>
                <div class="voice-recognition-status" id="voice_status" style="display: none;">
                    <div class="voice-wave">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <div class="voice-text">正在聆听...</div>
                </div>
                <div class="audio-controls">
                    <button id="play_audio" disabled>播放语音</button>
                    <button id="stop_audio" disabled>停止语音</button>
                </div>
                <div id="audio-status"></div>
            </div>
        </div>

        <!-- 高级情感系统 -->
        <div class="section">
            <div class="section-title">🎭 高级情感系统</div>
            <label>
                <input type="checkbox" id="advanced_emotion_enabled" checked> 启用高级情感系统
            </label>

            <!-- 情感系统状态 -->
            <div id="emotion_system_status" style="margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 12px;"></div>

            <!-- 当前情感状态显示 -->
            <div id="current_emotion_display" style="margin: 10px 0; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                <div style="font-weight: bold; margin-bottom: 5px;">当前情感状态:</div>
                <div id="emotion_type_display">中性</div>
                <div id="emotion_intensity_display">强度: 轻微</div>
                <div id="emotion_transition_display" style="font-size: 11px; color: #666;"></div>
            </div>

            <!-- 手动情感控制 -->
            <div style="margin: 10px 0;">
                <label>手动设置情感:</label>
                <select id="manual_emotion_type">
                    <option value="neutral">中性</option>
                    <option value="happy">开心</option>
                    <option value="sad">悲伤</option>
                    <option value="angry">生气</option>
                    <option value="surprised">惊讶</option>
                    <option value="confused">困惑</option>
                    <option value="shy">害羞</option>
                    <option value="excited">兴奋</option>
                    <option value="worried">担心</option>
                    <option value="loving">喜爱</option>
                    <option value="thinking">思考</option>
                    <option value="sleepy">困倦</option>
                </select>
                <input type="range" id="manual_emotion_intensity" min="0.1" max="1.0" step="0.1" value="0.8">
                <button onclick="setManualEmotion()">设置</button>
            </div>

            <!-- 手势控制 -->
            <div style="margin: 10px 0;">
                <label>触发手势:</label>
                <select id="gesture_type">
                    <option value="blink">眨眼</option>
                    <option value="nod">点头</option>
                    <option value="shake">摇头</option>
                    <option value="wave">挥手</option>
                    <option value="thinking">思考</option>
                </select>
                <button onclick="triggerGesture()">触发</button>
            </div>

            <!-- 自动动画控制 -->
            <div style="margin: 10px 0;">
                <label>
                    <input type="checkbox" id="auto_blink" checked> 自动眨眼
                </label>
                <label>
                    <input type="checkbox" id="auto_idle" checked> 自动空闲动画
                </label>
            </div>

            <!-- 情感历史 -->
            <div style="margin: 10px 0;">
                <button onclick="showEmotionHistory()">查看情感历史</button>
                <button onclick="resetEmotion()">重置到中性</button>
            </div>

            <!-- 情感历史显示 -->
            <div id="emotion_history_display" style="max-height: 100px; overflow-y: auto; font-size: 11px; display: none;"></div>
        </div>

        <!-- 多模态AI系统 -->
        <div class="section">
            <div class="section-title">🖼️ 多模态AI系统</div>
            <label>
                <input type="checkbox" id="multimodal_enabled"> 启用多模态功能
            </label>

            <!-- 多模态系统状态 -->
            <div id="multimodal_status" style="margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 12px;"></div>

            <div id="multimodal_controls" style="display: none;">
                <!-- 图像上传 -->
                <div style="margin: 10px 0;">
                    <label>上传图像:</label>
                    <input type="file" id="image_upload" accept="image/*" style="margin: 5px 0;">
                    <button id="upload_image_btn" onclick="uploadImage()">上传</button>
                </div>

                <!-- 上传进度 -->
                <div id="image_upload_progress" style="display: none; margin: 10px 0;">
                    <div style="background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                        <div id="image_progress_bar" style="height: 20px; background: #4CAF50; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="image_progress_text" style="font-size: 12px; margin-top: 5px;"></div>
                </div>

                <!-- 图像列表 -->
                <div id="uploaded_images" style="max-height: 200px; overflow-y: auto; margin: 10px 0;"></div>

                <!-- 图像分析 -->
                <div style="margin: 10px 0;">
                    <label>选择图像:</label>
                    <select id="selected_image_id" style="width: 60%;">
                        <option value="">请选择图像</option>
                    </select>
                    <button onclick="analyzeSelectedImage()" style="width: 35%;">分析</button>
                </div>

                <!-- 图像问答 -->
                <div style="margin: 10px 0;">
                    <input type="text" id="image_question" placeholder="对图像提问..." style="width: 70%;">
                    <button onclick="askImageQuestion()" style="width: 25%;">提问</button>
                </div>

                <!-- 多模态搜索 -->
                <div style="margin: 10px 0;">
                    <input type="text" id="multimodal_search_query" placeholder="搜索图像和文本..." style="width: 50%;">
                    <select id="search_type" style="width: 20%;">
                        <option value="all">全部</option>
                        <option value="images">图像</option>
                        <option value="text">文本</option>
                    </select>
                    <button onclick="searchMultimodal()" style="width: 25%;">搜索</button>
                </div>

                <!-- 搜索结果 -->
                <div id="multimodal_search_results" style="max-height: 150px; overflow-y: auto; font-size: 11px;"></div>

                <!-- 图像比较 -->
                <div style="margin: 10px 0;">
                    <label>图像比较:</label>
                    <select id="compare_image1" style="width: 30%;">
                        <option value="">图像1</option>
                    </select>
                    <select id="compare_image2" style="width: 30%;">
                        <option value="">图像2</option>
                    </select>
                    <button onclick="compareImages()" style="width: 35%;">比较</button>
                </div>

                <!-- 比较结果 -->
                <div id="image_comparison_result" style="font-size: 11px; margin: 10px 0;"></div>
            </div>
        </div>

        <!-- 语音情感系统 -->
        <div class="section">
            <div class="section-title">🎵 语音情感系统</div>
            <label>
                <input type="checkbox" id="voice_emotion_enabled"> 启用语音情感功能
            </label>

            <!-- 语音情感系统状态 -->
            <div id="voice_emotion_status" style="margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 12px;"></div>

            <div id="voice_emotion_controls" style="display: none;">
                <!-- 语音风格选择 -->
                <div style="margin: 10px 0;">
                    <label>语音风格:</label>
                    <select id="voice_style_select" style="width: 70%;">
                        <option value="default">默认风格</option>
                        <option value="gentle">温柔风格</option>
                        <option value="energetic">活力风格</option>
                        <option value="calm">平静风格</option>
                        <option value="cute">可爱风格</option>
                    </select>
                    <button onclick="setVoiceStyle()" style="width: 25%;">设置</button>
                </div>

                <!-- 语音角色选择 -->
                <div style="margin: 10px 0;">
                    <label>语音角色:</label>
                    <select id="voice_character_select" style="width: 50%;">
                        <option value="xiaoxiao">晓晓(女声)</option>
                        <option value="yunxi">云希(男声)</option>
                        <option value="xiaoyi">晓伊(女声)</option>
                        <option value="yunjian">云健(男声)</option>
                        <option value="xiaomeng">晓梦(女声)</option>
                    </select>
                    <select id="voice_language_select" style="width: 30%;">
                        <option value="zh-CN">中文</option>
                        <option value="en-US">英文</option>
                    </select>
                    <button onclick="setVoiceCharacter()" style="width: 15%;">设置</button>
                </div>

                <!-- 情感设置 -->
                <div style="margin: 10px 0;">
                    <label>情感类型:</label>
                    <select id="emotion_type_select" style="width: 40%;">
                        <option value="neutral">中性</option>
                        <option value="happy">开心</option>
                        <option value="sad">悲伤</option>
                        <option value="excited">兴奋</option>
                        <option value="calm">平静</option>
                        <option value="angry">生气</option>
                        <option value="surprised">惊讶</option>
                        <option value="confused">困惑</option>
                        <option value="shy">害羞</option>
                        <option value="worried">担心</option>
                        <option value="loving">喜爱</option>
                        <option value="thinking">思考</option>
                        <option value="sleepy">困倦</option>
                    </select>
                    <label>强度:</label>
                    <input type="range" id="emotion_intensity" min="0.1" max="1.0" step="0.1" value="1.0" style="width: 30%;">
                    <span id="emotion_intensity_value">1.0</span>
                </div>

                <!-- 语音测试 -->
                <div style="margin: 10px 0;">
                    <input type="text" id="voice_test_text" placeholder="输入测试文本..." style="width: 60%;" value="你好，这是语音测试。">
                    <button onclick="testVoiceSynthesis()" style="width: 20%;">测试</button>
                    <button onclick="synthesizeRealtime()" style="width: 15%;">实时</button>
                </div>

                <!-- 语音设置 -->
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" id="auto_language_detection"> 自动语言检测
                    </label>
                    <label>
                        <input type="checkbox" id="auto_play_voice"> 自动播放语音
                    </label>
                    <label>
                        <input type="checkbox" id="realtime_synthesis"> 实时合成
                    </label>
                </div>

                <!-- 情感敏感度 -->
                <div style="margin: 10px 0;">
                    <label>情感敏感度:</label>
                    <input type="range" id="emotion_sensitivity" min="0.1" max="2.0" step="0.1" value="1.0" style="width: 60%;">
                    <span id="emotion_sensitivity_value">1.0</span>
                    <button onclick="setEmotionSensitivity()" style="width: 20%;">设置</button>
                </div>

                <!-- 任务状态 -->
                <div id="voice_task_status" style="max-height: 100px; overflow-y: auto; font-size: 11px; margin: 10px 0;"></div>

                <!-- 语音统计 -->
                <div id="voice_statistics" style="font-size: 11px; color: #666; margin: 10px 0;"></div>
            </div>
        </div>

        <!-- 高级RAG系统 -->
        <div class="section">
            <div class="section-title">🧠 高级RAG系统</div>
            <label>
                <input type="checkbox" id="advanced_rag_enabled"> 启用高级RAG功能
            </label>

            <!-- 高级RAG系统状态 -->
            <div id="advanced_rag_status" style="margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 12px;"></div>

            <div id="advanced_rag_controls" style="display: none;">
                <!-- 文档处理 -->
                <div style="margin: 10px 0;">
                    <label>高级文档处理:</label>
                    <textarea id="advanced_doc_text" placeholder="输入文档内容..." style="width: 100%; height: 60px;"></textarea>
                    <div style="margin: 5px 0;">
                        <input type="text" id="advanced_doc_id" placeholder="文档ID（可选）" style="width: 40%;">
                        <input type="text" id="advanced_image_path" placeholder="图像路径（可选）" style="width: 40%;">
                        <button onclick="processAdvancedDocument()" style="width: 15%;">处理</button>
                    </div>
                </div>

                <!-- 高级查询 -->
                <div style="margin: 10px 0;">
                    <label>高级查询:</label>
                    <input type="text" id="advanced_query_text" placeholder="输入查询问题..." style="width: 60%;">
                    <select id="advanced_query_type" style="width: 20%;">
                        <option value="auto">自动</option>
                        <option value="graph">图查询</option>
                        <option value="reasoning">推理</option>
                        <option value="fusion">融合</option>
                    </select>
                    <button onclick="executeAdvancedQuery()" style="width: 15%;">查询</button>
                </div>

                <!-- 多模态推理 -->
                <div style="margin: 10px 0;">
                    <label>多模态推理:</label>
                    <input type="text" id="reasoning_query" placeholder="推理问题..." style="width: 50%;">
                    <select id="reasoning_type" style="width: 25%;">
                        <option value="path_based">路径推理</option>
                        <option value="subgraph_matching">子图匹配</option>
                        <option value="random_walk">随机游走</option>
                    </select>
                    <button onclick="executeMultimodalReasoning()" style="width: 20%;">推理</button>
                </div>

                <!-- 知识图谱操作 -->
                <div style="margin: 10px 0;">
                    <label>知识图谱:</label>
                    <button onclick="buildKnowledgeGraph()" style="width: 20%;">构建图谱</button>
                    <button onclick="getGraphStats()" style="width: 20%;">图谱统计</button>
                    <button onclick="clearAdvancedCaches()" style="width: 20%;">清理缓存</button>
                    <button onclick="visualizeGraph()" style="width: 20%;">可视化</button>
                </div>

                <!-- 向量化测试 -->
                <div style="margin: 10px 0;">
                    <label>向量化测试:</label>
                    <input type="text" id="vectorize_text" placeholder="测试文本..." style="width: 50%;">
                    <select id="fusion_strategy" style="width: 25%;">
                        <option value="concatenate">拼接</option>
                        <option value="average">平均</option>
                        <option value="weighted">加权</option>
                        <option value="attention">注意力</option>
                    </select>
                    <button onclick="testVectorization()" style="width: 20%;">向量化</button>
                </div>

                <!-- 高级设置 -->
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" id="include_reasoning"> 包含推理
                    </label>
                    <label>
                        <input type="checkbox" id="enable_fusion"> 启用融合
                    </label>
                    <label>
                        <input type="checkbox" id="multimodal_mode"> 多模态模式
                    </label>
                </div>

                <!-- 结果显示 -->
                <div id="advanced_rag_results" style="max-height: 200px; overflow-y: auto; font-size: 11px; margin: 10px 0; border: 1px solid #ddd; padding: 5px;"></div>

                <!-- 系统统计 -->
                <div id="advanced_rag_statistics" style="font-size: 11px; color: #666; margin: 10px 0;"></div>
            </div>
        </div>

        <!-- RAG知识库管理 -->
        <div class="section">
            <div class="section-title">📚 知识库管理</div>
            <label>
                <input type="checkbox" id="rag_enabled"> 启用RAG增强对话
            </label>
            <div id="rag_status" style="margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 12px;"></div>

            <div id="rag_controls" style="display: none;">
                <!-- 文档上传 -->
                <div style="margin: 10px 0;">
                    <label>上传文档:</label>
                    <input type="file" id="document_upload" accept=".pdf,.docx,.doc,.txt,.md" style="margin: 5px 0;">
                    <button id="upload_btn" onclick="uploadDocument()">上传</button>
                </div>

                <!-- 上传进度 -->
                <div id="upload_progress" style="display: none; margin: 10px 0;">
                    <div style="background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                        <div id="progress_bar" style="height: 20px; background: #4CAF50; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progress_text" style="font-size: 12px; margin-top: 5px;"></div>
                </div>

                <!-- 知识库信息 -->
                <div id="knowledge_base_info" style="margin: 10px 0; font-size: 12px;"></div>

                <!-- 文档列表 -->
                <div id="document_list" style="max-height: 150px; overflow-y: auto; margin: 10px 0;"></div>

                <!-- 搜索测试 -->
                <div style="margin: 10px 0;">
                    <input type="text" id="search_query" placeholder="搜索文档内容..." style="width: 70%;">
                    <button onclick="searchDocuments()" style="width: 25%;">搜索</button>
                </div>
                <div id="search_results" style="max-height: 100px; overflow-y: auto; font-size: 11px;"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">背景设置</div>

            <div class="tabs">
                <div class="tab active" data-tab="color">纯色背景</div>
                <div class="tab" data-tab="image">图片背景</div>
            </div>

            <div class="tab-content active" id="color-tab">
                <div class="bg-option">
                    <label for="bg_color">背景颜色:</label>
                    <input type="color" id="bg_color" value="#FFFFFF">
                </div>
                <button id="update_bg_color">更新背景颜色</button>
            </div>

            <div class="tab-content" id="image-tab">
                <select id="bg_image_preset">
                    <option value="">- 选择预设背景 -</option>
                    <option value="./backgrounds/classroom.jpg">教室</option>
                    <option value="./backgrounds/beach.jpg">海滩</option>
                    <option value="./backgrounds/forest.jpg">森林</option>
                    <option value="./backgrounds/space.jpg">太空</option>
                </select>

                <div class="bg-input-group">
                    <label for="bg_image_url">自定义背景图片URL:</label>
                    <input type="url" id="bg_image_url" placeholder="输入图片URL...">
                </div>
                <button id="update_bg_image">更新背景图片</button>
            </div>
        </div>
    </div>

    <!-- 添加LFS检查结果弹窗 -->
    <div id="lfs_dialog" class="dialog" style="display: none;">
        <div class="dialog-content">
            <span class="close-btn">&times;</span>
            <h3>模型文件检查结果</h3>
            <div id="lfs_check_result"></div>
            <div class="dialog-actions">
                <button id="close_lfs_dialog">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // Live2D 模型配置
        const modelPaths = {
            'March 7th': './models/March 7th/March 7th.model3.json',
            'kei_vowels_pro': './models/kei_vowels_pro/kei_vowels_pro.model3.json',
            'Nova - F': './models/Nova - F/Nova - F.model3.json',
            'Hiyori': './models/Hiyori/Hiyori.model3.json',
            'pachan': './models/pachan/pachan.model3.json',
            'EVA RIN normal': './models/EVA RIN normal/EVA RIN normal.model3.json'
        };

        // 添加模型类型映射
        const modelTypes = {
            'March 7th': 'cubism4',
            'kei_vowels_pro': 'cubism4',
            'Nova - F': 'cubism4',
            'Hiyori': 'cubism4',
            'pachan': 'cubism4',
            'EVA RIN normal': 'cubism4'
        };

        // 添加情绪和动作系统
        const emotionKeywords = {
            '开心': ['高兴', '快乐', '欢喜', '喜悦', '兴奋', '愉快', '笑'],
            '悲伤': ['难过', '伤心', '哭', '忧伤', '悲痛', '难受', '苦恼', '不开心'],
            '惊讶': ['震惊', '吃惊', '惊讶', '意外', '没想到', '不可思议'],
            '生气': ['愤怒', '恼火', '不爽', '讨厌', '恨', '烦躁', '不悦'],
            '害羞': ['羞涩', '害羞', '不好意思', '腼腆', '难为情'],
            '疑惑': ['困惑', '疑问', '不解', '迷惑', '不明白', '不懂']
        };

        // 对应的表情和动作配置
        const expressionActions = {
            '开心': {
                parameterIds: ['ParamMouthForm', 'ParamEyeLOpen', 'ParamEyeROpen', 'ParamBrowLY', 'ParamBrowRY'],
                parameterValues: [1, 0.8, 0.8, 0.5, 0.5],
                duration: 8000,  // 表情持续时间（毫秒）
                priority: 2      // 表情优先级
            },
            '悲伤': {
                parameterIds: ['ParamMouthForm', 'ParamEyeLOpen', 'ParamEyeROpen', 'ParamBrowLY', 'ParamBrowRY'],
                parameterValues: [-0.8, 0.5, 0.5, -0.8, -0.8],
                duration: 10000,
                priority: 3
            },
            '惊讶': {
                parameterIds: ['ParamMouthOpenY', 'ParamEyeLOpen', 'ParamEyeROpen', 'ParamBrowLY', 'ParamBrowRY'],
                parameterValues: [0.5, 1.2, 1.2, 1, 1],
                duration: 7000,
                priority: 3
            },
            '生气': {
                parameterIds: ['ParamMouthForm', 'ParamEyeLOpen', 'ParamEyeROpen', 'ParamBrowLY', 'ParamBrowRY'],
                parameterValues: [-0.5, 0.8, 0.8, -1, -1],
                duration: 10000,
                priority: 3
            },
            '害羞': {
                parameterIds: ['ParamMouthForm', 'ParamEyeLOpen', 'ParamEyeROpen', 'ParamBrowLY', 'ParamBrowRY'],
                parameterValues: [0.2, 0.7, 0.7, 0.2, 0.2],
                duration: 8000,
                priority: 2
            },
            '疑惑': {
                parameterIds: ['ParamMouthForm', 'ParamEyeLOpen', 'ParamEyeROpen', 'ParamBrowLY', 'ParamBrowRY'],
                parameterValues: [0, 0.8, 0.8, -0.5, 0.5],
                duration: 6000,
                priority: 1
            }
        };

        // 口型同步参数配置
        const lipSyncParams = {
            // 控制嘴巴开合的参数
            mouthOpenY: 'ParamMouthOpenY',  // 嘴巴开合参数
            mouthForm: 'ParamMouthForm',    // 嘴巴形态参数
            // 眨眼相关参数
            eyeL: 'ParamEyeLOpen',          // 左眼开合参数
            eyeR: 'ParamEyeROpen',          // 右眼开合参数
            // 动画配置
            blinkInterval: [3000, 7000],    // 眨眼间隔范围（毫秒）
            blinkDuration: 100,             // 眨眼持续时间（毫秒）
            // 音频分析配置
            audioAnalysisInterval: 50,      // 音频分析间隔（毫秒）
            mouthOpenMax: 1.5,              // 嘴巴最大开度
            mouthOpenMin: 0.0,              // 嘴巴最小开度
            volumeThreshold: 0.01           // 音量阈值
        };

        // 添加动作配置
        const motionGroups = {
            '打招呼': ['motion/tap_head.motion3.json', 'motion/shake_body.motion3.json'],
            '点头': ['motion/nod.motion3.json'],
            '摇头': ['motion/shake_head.motion3.json'],
            '思考': ['motion/thinking.motion3.json'],
            '跳舞': ['motion/dance.motion3.json']
        };

        let currentModel;
        let app;
        let chatHistory = [];
        let currentAudio = null;
        let lastAudioUrl = null;
        let currentExpression = null;
        let expressionTimeout = null;
        let lipSyncActive = false;
        let lipSyncInterval = null;
        let lastBlinkTime = 0;
        let audioContext = null;
        let audioAnalyser = null;
        let audioDataArray = null;

        // 初始化模型选择下拉框
        const $modelSelect = $("#model_list");
        Object.keys(modelPaths).forEach(model => {
            $modelSelect.append($("<option>").attr("value", model).text(model));
        });

        // 音频控制函数
        function updateAudioStatus(message) {
            document.getElementById('audio-status').textContent = message;
        }

        function enableAudioControls(enabled = true) {
            document.getElementById('play_audio').disabled = !enabled;
            document.getElementById('stop_audio').disabled = !enabled || !currentAudio;
        }

        function playAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                stopLipSync();
            }

            if (lastAudioUrl) {
                currentAudio = new Audio(lastAudioUrl);
                currentAudio.volume = parseFloat(document.getElementById('volume').value);

                // 准备音频分析
                setupAudioAnalysis(currentAudio);

                currentAudio.onplay = () => {
                    enableAudioControls(true);
                    document.getElementById('play_audio').disabled = true;
                    document.getElementById('stop_audio').disabled = false;
                    updateAudioStatus('正在播放...');
                    // 开始口型同步
                    startLipSync();
                };

                currentAudio.onended = () => {
                    enableAudioControls(true);
                    document.getElementById('stop_audio').disabled = true;
                    updateAudioStatus('播放完成');
                    // 停止口型同步
                    stopLipSync();
                };

                currentAudio.onerror = () => {
                    updateAudioStatus('音频播放失败');
                    enableAudioControls(false);
                    stopLipSync();
                };

                currentAudio.play().catch(error => {
                    console.error('播放音频失败:', error);
                    updateAudioStatus('播放失败: ' + error.message);
                    stopLipSync();
                });
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                document.getElementById('play_audio').disabled = false;
                document.getElementById('stop_audio').disabled = true;
                updateAudioStatus('已停止播放');
                // 停止口型同步
                stopLipSync();
            }
        }

        // 新增：音频分析和口型同步功能
        function setupAudioAnalysis(audio) {
            try {
                // 清理旧的分析器
                if (audioAnalyser) {
                    try {
                        audioAnalyser.disconnect();
                    } catch (e) {
                        console.log("断开旧分析器连接时出错:", e);
                    }
                    audioAnalyser = null;
                }

                // 确保AudioContext已初始化
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        console.log("AudioContext已初始化");
                    } catch (error) {
                        console.error("初始化AudioContext失败:", error);
                        return;
                    }
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume().catch(err => {
                        console.error("恢复AudioContext失败:", err);
                    });
                }

                if (!audioContext || audioContext.state === 'closed') {
                    console.warn("AudioContext不可用，无法设置音频分析");
                    return;
                }

                // 创建媒体元素源和分析器
                const source = audioContext.createMediaElementSource(audio);
                audioAnalyser = audioContext.createAnalyser();
                audioAnalyser.fftSize = 256;

                // 连接音频节点：源 -> 分析器 -> 输出
                source.connect(audioAnalyser);
                audioAnalyser.connect(audioContext.destination);

                // 创建数据数组接收频域数据
                const bufferLength = audioAnalyser.frequencyBinCount;
                audioDataArray = new Uint8Array(bufferLength);

                console.log("音频分析器已设置完成");

            } catch (error) {
                console.error("设置音频分析失败:", error);
                if (error.name === "InvalidAccessError") {
                    console.error("可能是重复连接媒体源，尝试使用新的AudioContext");
                    audioContext = null;
                    audioAnalyser = null;
                    audioDataArray = null;
                    // 延迟重试一次
                    setTimeout(() => setupAudioAnalysis(audio), 100);
                    return;
                }
                audioAnalyser = null;
                audioDataArray = null;
            }
        }

        // 启动口型同步
        function startLipSync() {
            if (lipSyncActive || !currentModel) return;

            // 检查是否禁用了口型同步
            if (!$('#lipsync_enabled').is(':checked')) {
                return;
            }

            // 确保有效的音频分析器
            if (!audioAnalyser || !audioDataArray) {
                console.warn("音频分析器未准备好，无法启动口型同步");
                return;
            }

            lipSyncActive = true;
            lastBlinkTime = Date.now();

            console.log("开始口型同步");

            // 开始口型同步定时器
            lipSyncInterval = setInterval(() => {
                if (!currentAudio || currentAudio.paused) {
                    resetMouthParameters();
                    return;
                }

                try {
                    // 获取音频数据
                    audioAnalyser.getByteFrequencyData(audioDataArray);

                    // 计算平均音量 (简单方法)
                    let sum = 0;
                    for (let i = 0; i < audioDataArray.length; i++) {
                        sum += audioDataArray[i];
                    }
                    const averageVolume = sum / audioDataArray.length / 255; // 归一化到0-1

                    // 根据音量设置嘴型参数
                    if (averageVolume > lipSyncParams.volumeThreshold) {
                        const mouthOpen = lipSyncParams.mouthOpenMin +
                                        (averageVolume * (lipSyncParams.mouthOpenMax - lipSyncParams.mouthOpenMin));

                        // 设置嘴巴开合度
                        setMouthParameters(mouthOpen);
                    } else {
                        // 音量低于阈值，关闭嘴巴
                        resetMouthParameters();
                    }

                    // 随机眨眼
                    const now = Date.now();
                    if (now - lastBlinkTime > getRandomInt(lipSyncParams.blinkInterval[0], lipSyncParams.blinkInterval[1])) {
                        blinkEyes();
                        lastBlinkTime = now;
                    }
                } catch (error) {
                    console.error("口型同步更新失败:", error);
                }

            }, lipSyncParams.audioAnalysisInterval);

            console.log("已启动口型同步");
        }

        // 停止口型同步
        function stopLipSync() {
            if (lipSyncInterval) {
                clearInterval(lipSyncInterval);
                lipSyncInterval = null;
            }

            // 重置口型参数
            resetMouthParameters();
            lipSyncActive = false;
            console.log("已停止口型同步");
        }

        // 设置嘴型参数
        function setMouthParameters(openValue) {
            if (!currentModel) return;

            try {
                // 设置嘴巴开合度
                currentModel.internalModel.coreModel.setParameterValueById(
                    lipSyncParams.mouthOpenY,
                    Math.min(Math.max(openValue, 0), lipSyncParams.mouthOpenMax)
                );

                // 微调嘴型形态，让动画更自然
                const formValue = openValue > 0.5 ? -0.2 : 0.1; // 嘴巴大开时收紧嘴角
                currentModel.internalModel.coreModel.setParameterValueById(
                    lipSyncParams.mouthForm,
                    formValue
                );
            } catch (error) {
                console.warn("设置嘴型参数失败:", error);
            }
        }

        // 重置嘴型参数
        function resetMouthParameters() {
            if (!currentModel) return;

            try {
                // 重置嘴巴开合和形态
                currentModel.internalModel.coreModel.setParameterValueById(lipSyncParams.mouthOpenY, 0);
                currentModel.internalModel.coreModel.setParameterValueById(lipSyncParams.mouthForm, 0);
            } catch (error) {
                console.warn("重置嘴型参数失败:", error);
            }
        }

        // 眨眼动画
        function blinkEyes() {
            if (!currentModel) return;

            try {
                // 快速闭眼
                currentModel.internalModel.coreModel.setParameterValueById(lipSyncParams.eyeL, 0);
                currentModel.internalModel.coreModel.setParameterValueById(lipSyncParams.eyeR, 0);

                // 恢复睁眼
                setTimeout(() => {
                    currentModel.internalModel.coreModel.setParameterValueById(lipSyncParams.eyeL, 1);
                    currentModel.internalModel.coreModel.setParameterValueById(lipSyncParams.eyeR, 1);
                }, lipSyncParams.blinkDuration);
            } catch (error) {
                console.warn("眨眼动画失败:", error);
            }
        }

        // 辅助函数：获取指定范围内的随机整数
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // 背景控制函数
        function updateBackgroundColor(color) {
            document.getElementById('background').style.backgroundColor = color;
            document.getElementById('background').style.backgroundImage = 'none';
        }

        function updateBackgroundImage(url) {
            if (url) {
                document.getElementById('background').style.backgroundImage = `url('${url}')`;
            } else {
                alert('请输入有效的图片URL');
            }
        }

        // 加载Live2D模型
        async function loadModel(modelName) {
            try {
                console.log("开始清理旧模型资源...");
                // 清理现有模型的状态
                if (currentModel) {
                    console.log("发现旧模型，执行清理流程");
                    // 停止口型同步
                    stopLipSync();

                    // 清理表情计时器
                    if (expressionTimeout) {
                        clearTimeout(expressionTimeout);
                        expressionTimeout = null;
                    }

                    // 移除旧模型
                    console.log("从舞台移除旧模型");
                    app.stage.removeChild(currentModel);

                    // 完全销毁模型实例
                    console.log("销毁旧模型资源");
                    if (typeof currentModel.destroy === 'function') {
                        currentModel.destroy({children: true, texture: true, baseTexture: true});
                    }
                    currentModel = null;

                    // 强制垃圾回收提示
                    setTimeout(() => {
                        // 可选：手动执行一次浏览器垃圾回收
                        if (window.gc) window.gc();
                        console.log("旧模型清理完成");
                    }, 100);
                }

                // 初始化PIXI应用或清理舞台
                if (!app) {
                    console.log("创建PIXI应用");
                    // 创建PIXI应用
                    app = new PIXI.Application({
                        view: document.getElementById("canvas"),
                        autoStart: true,
                        resizeTo: window,
                        transparent: true,
                        backgroundAlpha: 0
                    });
                } else {
                    console.log("清理PIXI舞台");
                    // 清理舞台，移除所有子元素
                    while(app.stage.children.length > 0) {
                        const child = app.stage.getChildAt(0);
                        app.stage.removeChild(child);
                        if (typeof child.destroy === 'function') {
                            child.destroy({children: true, texture: true, baseTexture: true});
                        }
                    }
                }

                // 确保舞台是空的
                console.log("当前舞台子元素数量:", app.stage.children.length);

                // 获取模型路径
                const modelPath = modelPaths[modelName];
                console.log("准备加载新模型:", modelPath);

                // 检查模型类型
                let modelType = modelTypes[modelName] || 'cubism4';
                const isModelCubism2 = modelPath.endsWith('.model.json');
                const isModelCubism4 = modelPath.endsWith('.model3.json');

                // 根据文件扩展名确定实际类型
                if (isModelCubism2) modelType = 'cubism2';
                if (isModelCubism4) modelType = 'cubism4';

                console.log("模型类型:", modelType);

                // 根据类型选择加载方法
                let model;
                if (modelType === 'cubism2') {
                    // 使用Cubism 2引擎加载
                    console.log("使用Cubism 2引擎加载模型");

                    // 检查是否加载了Cubism 2引擎
                    if (typeof Live2D === 'undefined') {
                        throw new Error("Cubism 2引擎未加载，无法加载Cubism 2模型");
                    }

                    // 这里实现Cubism 2模型加载逻辑
                    // 注意：这需要完整的Cubism 2加载实现
                    alert("Cubism 2模型加载尚未完全实现，请使用Cubism 4模型");
                    throw new Error("Cubism 2模型加载尚未实现");
                } else {
                    // 使用Cubism 4引擎加载
                    console.log("使用Cubism 4引擎加载模型");
                    model = await PIXI.live2d.Live2DModel.from(modelPath);
                }

                console.log("模型加载完成，添加到舞台");
                app.stage.addChild(model);

                // 调整模型大小和位置
                const scale = Math.min(innerWidth / model.width, innerHeight / model.height);
                model.scale.set(scale);
                model.y = innerHeight * 0.1;
                model.x = innerWidth / 2;

                // 设置当前模型引用
                currentModel = model;

                // 添加交互能力
                model.on('hit', (hitAreas) => {
                    console.log('Touched area:', hitAreas);
                    if (hitAreas.includes('Head')) {
                        playModelMotion('打招呼');
                    } else if (hitAreas.includes('Body')) {
                        playModelMotion('点头');
                    }
                });

                // 加载默认表情
                setModelExpression('开心');

                // 记录加载成功
                console.log("模型加载成功:", modelName);
                return model;
            } catch (error) {
                console.error("加载模型失败:", error);

                // 记录详细错误信息
                if (error.message === "Invalid moc data") {
                    console.error("可能原因：模型格式与引擎不兼容，或模型文件损坏");

                    // 发送错误信息到服务器进行记录
                    try {
                        await fetch('/api/log_model_error', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model_path: modelPaths[modelName],
                                error: error.message,
                                stack: error.stack
                            })
                        });
                    } catch (logError) {
                        console.error("无法记录错误:", logError);
                    }

                    // 提示用户
                    alert(`加载模型失败：模型格式可能与引擎不兼容\n请检查 ${modelName} 是否为Cubism 4格式的模型`);
                } else {
                    alert(`加载模型失败：${error.message}`);
                }
            }
        }

        // 新增：设置模型表情
        async function setModelExpression(expressionName) {
            if (!currentModel) return;

            try {
                const config = expressionActions[expressionName];
                if (!config) {
                    console.warn(`未找到表情配置: ${expressionName}`);
                    return;
                }

                // 检查是否应该覆盖当前表情
                if (currentExpression) {
                    const currentConfig = expressionActions[currentExpression];
                    if (currentConfig && currentConfig.priority > config.priority) {
                        console.log(`表情 ${expressionName} 优先级低于当前表情 ${currentExpression}，不切换`);
                        return;
                    }
                }

                // 清除之前的表情timeout
                if (expressionTimeout) {
                    clearTimeout(expressionTimeout);
                    expressionTimeout = null;
                }

                console.log(`设置表情: ${expressionName}`);

                // 使用参数控制设置表情
                if (config.parameterIds && config.parameterValues) {
                    for (let i = 0; i < config.parameterIds.length; i++) {
                        const paramId = config.parameterIds[i];
                        const paramValue = config.parameterValues[i];

                        try {
                            // 使用补间动画平滑过渡
                            const currentValue = currentModel.internalModel.coreModel.getParameterValueById(paramId);
                            animateParameter(paramId, currentValue, paramValue, 300); // 300ms平滑过渡
                        } catch (paramError) {
                            console.warn(`设置参数失败 ${paramId}: ${paramError.message}`);
                            // 尝试直接设置
                            try {
                                currentModel.internalModel.coreModel.setParameterValueById(paramId, paramValue);
                            } catch (e) {
                                console.error(`设置参数彻底失败 ${paramId}: ${e.message}`);
                            }
                        }
                    }
                }

                currentExpression = expressionName;

                // 设置表情持续时间
                const duration = config.duration || 5000;

                // 定时恢复默认表情
                expressionTimeout = setTimeout(() => {
                    try {
                        // 平滑恢复默认表情参数
                        if (config.parameterIds) {
                            for (let i = 0; i < config.parameterIds.length; i++) {
                                const paramId = config.parameterIds[i];
                                const currentValue = currentModel.internalModel.coreModel.getParameterValueById(paramId);
                                animateParameter(paramId, currentValue, 0, 500); // 500ms平滑过渡到默认值
                            }
                        }

                        console.log(`表情 ${expressionName} 已恢复默认状态`);
                        currentExpression = null;
                    } catch (e) {
                        console.warn("恢复默认表情失败:", e);
                    }

                    expressionTimeout = null;
                }, duration);

            } catch (error) {
                console.error(`设置表情失败 ${expressionName}:`, error);
            }
        }

        // 参数动画函数：平滑过渡
        function animateParameter(paramId, startValue, targetValue, duration) {
            if (!currentModel) return;

            const startTime = Date.now();
            const animate = () => {
                if (!currentModel) return;

                const now = Date.now();
                const elapsed = now - startTime;

                if (elapsed >= duration) {
                    // 动画结束，设置最终值
                    currentModel.internalModel.coreModel.setParameterValueById(paramId, targetValue);
                    return;
                }

                // 计算当前进度（使用缓动函数）
                const progress = elapsed / duration;
                const easedProgress = 0.5 - 0.5 * Math.cos(Math.PI * progress);

                // 计算当前值
                const currentValue = startValue + (targetValue - startValue) * easedProgress;

                // 设置参数值
                currentModel.internalModel.coreModel.setParameterValueById(paramId, currentValue);

                // 继续动画
                requestAnimationFrame(animate);
            };

            // 启动动画
            animate();
        }

        // 新增：播放模型动作
        async function playModelMotion(motionType) {
            if (!currentModel) return;

            try {
                const motions = motionGroups[motionType];
                if (!motions || motions.length === 0) {
                    console.warn(`未找到动作组: ${motionType}`);
                    return;
                }

                // 随机选择一个动作
                const randomMotion = motions[Math.floor(Math.random() * motions.length)];
                console.log(`播放动作: ${motionType} - ${randomMotion}`);

                // 尝试播放动作
                try {
                    await currentModel.motion(motionType, randomMotion);
                } catch (motionError) {
                    console.warn(`无法使用motion方法播放动作: ${motionError.message}`);

                    // 尝试通过组名播放
                    try {
                        await currentModel.motion(motionType);
                    } catch (groupError) {
                        console.error(`通过组名播放动作失败: ${groupError.message}`);
                    }
                }
            } catch (error) {
                console.error(`播放动作失败 ${motionType}:`, error);
            }
        }

        // 新增：分析文本情感并触发表情和动作
        function analyzeEmotionAndPlayAction(text) {
            if (!text || !currentModel) return;

            // 将文本转为小写并去除标点
            const normalizedText = text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "");

            // 检测情感关键词
            let detectedEmotion = null;
            let maxMatches = 0;

            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                let matches = 0;
                for (const keyword of keywords) {
                    if (normalizedText.includes(keyword)) {
                        matches++;
                    }
                }

                if (matches > maxMatches) {
                    maxMatches = matches;
                    detectedEmotion = emotion;
                }
            }

            // 如果检测到情感，设置表情
            if (detectedEmotion && maxMatches > 0) {
                console.log(`检测到情感: ${detectedEmotion} (匹配度: ${maxMatches})`);
                setModelExpression(detectedEmotion);

                // 根据情感选择合适的动作
                if (detectedEmotion === '开心') {
                    playModelMotion('打招呼');
                } else if (detectedEmotion === '悲伤') {
                    playModelMotion('摇头');
                } else if (detectedEmotion === '惊讶') {
                    playModelMotion('跳舞');
                } else if (detectedEmotion === '疑惑') {
                    playModelMotion('思考');
                }
            }
        }



        // 语音识别相关变量和函数
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null; // Web Speech API

        // 初始化浏览器语音识别
        function initBrowserSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('浏览器不支持语音识别 API');
                return false;
            }

            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;

                // 设置语言
                recognition.lang = $('#voice_recognition_language').val() === 'zh' ? 'zh-CN' : 'en-US';

                recognition.onstart = function() {
                    console.log('浏览器语音识别开始');
                    $('#voice_input').addClass('recording');
                    $('#voice_status').show();
                    $('.voice-text').text('正在聆听...');

                    // 设置模型聆听状态
                    setModelExpression('疑惑');
                    playModelMotion('思考');
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (interimTranscript) {
                        $('.voice-text').text('识别中: ' + interimTranscript);
                    }

                    if (finalTranscript) {
                        $('#user_input').val(finalTranscript);
                        $('.voice-text').text('识别结果: ' + finalTranscript);

                        // 如果启用了自动发送
                        if ($('#auto_send_voice').is(':checked')) {
                            setTimeout(() => {
                                $('#send_message').click();
                            }, 500);
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('语音识别错误:', event.error);
                    $('.voice-text').text('识别错误: ' + event.error);
                    stopRecording();
                };

                recognition.onend = function() {
                    console.log('浏览器语音识别结束');
                    stopRecording();
                };

                return true;
            } catch (e) {
                console.error('初始化浏览器语音识别失败:', e);
                return false;
            }
        }

        // 初始化媒体录制
        async function initMediaRecorder() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstart = function() {
                    audioChunks = [];
                    console.log('开始录音');
                    $('#voice_input').addClass('recording');
                    $('#voice_status').show();
                    $('.voice-text').text('正在录音...');

                    // 设置模型聆听状态
                    setModelExpression('疑惑');
                    playModelMotion('思考');
                };

                mediaRecorder.onstop = async function() {
                    console.log('录音结束');
                    $('#voice_input').removeClass('recording');
                    $('.voice-text').text('正在识别...');

                    // 如果没有录制到音频数据，直接返回
                    if (audioChunks.length === 0) {
                        $('#voice_status').hide();
                        return;
                    }

                    // 将音频数据合并为一个 Blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                    // 根据识别模式选择不同的处理方式
                    if ($('#voice_recognition_mode').val() === 'server') {
                        // 服务器模式：发送到后端进行识别
                        await sendAudioToServer(audioBlob);
                    } else {
                        // 浏览器模式：使用 Web Speech API
                        if (recognition) {
                            // 已经在使用 Web Speech API 进行识别
                            $('#voice_status').hide();
                        } else {
                            $('.voice-text').text('浏览器模式不可用，已切换到服务器模式');
                            await sendAudioToServer(audioBlob);
                        }
                    }
                };

                return true;
            } catch (e) {
                console.error('初始化媒体录制器失败:', e);
                alert('无法访问麦克风，请检查浏览器权限设置。');
                return false;
            }
        }

        // 发送音频到服务器进行识别
        async function sendAudioToServer(audioBlob) {
            try {
                $('.voice-text').text('正在将音频发送到服务器...');

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('language', $('#voice_recognition_language').val());

                const response = await fetch('/api/recognize_voice', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    $('#user_input').val(result.text);
                    $('.voice-text').text('识别结果: ' + result.text);

                    // 如果启用了自动发送
                    if ($('#auto_send_voice').is(':checked')) {
                        setTimeout(() => {
                            $('#send_message').click();
                        }, 500);
                    }
                } else {
                    $('.voice-text').text('识别失败: ' + (result.error || '未知错误'));
                }

                // 3秒后隐藏状态
                setTimeout(() => {
                    $('#voice_status').hide();
                }, 3000);

            } catch (e) {
                console.error('发送音频到服务器失败:', e);
                $('.voice-text').text('发送失败: ' + e.message);

                // 3秒后隐藏状态
                setTimeout(() => {
                    $('#voice_status').hide();
                }, 3000);
            }
        }

        // 开始录音
        async function startRecording() {
            if (isRecording) return;

            // 检查是否启用语音识别
            if (!$('#voice_recognition_enabled').is(':checked')) {
                alert('语音识别已禁用，请在设置中启用。');
                return;
            }

            isRecording = true;

            // 根据识别模式选择不同的录音方式
            if ($('#voice_recognition_mode').val() === 'browser') {
                // 浏览器模式：使用 Web Speech API
                if (!recognition && !initBrowserSpeechRecognition()) {
                    // 如果浏览器不支持，切换到服务器模式
                    $('#voice_recognition_mode').val('server');
                    alert('浏览器不支持语音识别 API，已切换到服务器模式。');

                    // 初始化媒体录制器
                    if (!mediaRecorder && !await initMediaRecorder()) {
                        isRecording = false;
                        return;
                    }

                    // 开始录音
                    mediaRecorder.start();
                } else {
                    // 设置语言
                    recognition.lang = $('#voice_recognition_language').val() === 'zh' ? 'zh-CN' : 'en-US';
                    recognition.start();
                }
            } else {
                // 服务器模式：使用媒体录制器
                if (!mediaRecorder && !await initMediaRecorder()) {
                    isRecording = false;
                    return;
                }

                // 开始录音
                mediaRecorder.start();
            }
        }

        // 停止录音
        function stopRecording() {
            if (!isRecording) return;

            isRecording = false;
            $('#voice_input').removeClass('recording');

            if ($('#voice_recognition_mode').val() === 'browser' && recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.warn('停止语音识别时出错:', e);
                }
            } else if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            } else {
                $('#voice_status').hide();
            }
        }

        // 初始化 AudioContext
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                } catch (e) {
                    console.error('初始化 AudioContext 失败:', e);
                }
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // 事件监听器
        $(document).ready(function() {
            // 加载可用模型列表
            loadAvailableModels();

            // 设置模型更新按钮
            setupModelUpdateButton();

            // 语音识别按钮事件
            $('#voice_input').on('click', function() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            // 语音识别模式切换
            $('#voice_recognition_mode').on('change', function() {
                // 如果正在录音，停止录音
                if (isRecording) {
                    stopRecording();
                }

                // 重置语音识别状态
                recognition = null;
            });

            // 语言切换
            $('#voice_recognition_language').on('change', function() {
                // 如果正在录音，停止录音
                if (isRecording) {
                    stopRecording();
                }

                // 重置语音识别状态
                recognition = null;
            });

            // 标签切换事件增强
            $(".tab").click(function() {
                const tabGroup = $(this).parent();
                const tabId = $(this).data("tab");

                // 移除当前标签组中的所有激活标签
                tabGroup.find(".tab").removeClass("active");
                $(this).addClass("active");

                // 找到相关的内容容器
                const tabContents = tabGroup.parent().find(".tab-content");
                tabContents.removeClass("active");

                // 激活相应的内容
                $(`#${tabId}-tab`).addClass("active");
            });

            // 音量控制
            $("#volume").on('input', function() {
                const volume = parseFloat(this.value);
                $("#volume-value").text(Math.round(volume * 100) + '%');
                if (currentAudio) {
                    currentAudio.volume = volume;
                }
            });

            // 音频控制按钮
            $("#play_audio").click(function() {
                // 尝试初始化音频上下文（需要用户交互）
                initAudioContext();
                playAudio();
            });
            $("#stop_audio").click(stopAudio);

            // 发送消息按钮
            $("#send_message").click(function() {
                // 尝试初始化音频上下文（需要用户交互）
                initAudioContext();

                const message = $("#user_input").val().trim();
                if (message) {
                    sendMessage(message);
                    $("#user_input").val('');
                }
            });

            // 输入框回车发送
            $("#user_input").keypress(function(e) {
                if (e.which === 13) {
                    const message = $(this).val().trim();
                    if (message) {
                        sendMessage(message);
                        $(this).val('');
                    }
                    e.preventDefault();
                }
            });

            // 标签切换
            $(".tab").click(function() {
                $(".tab").removeClass("active");
                $(this).addClass("active");

                const tabId = $(this).data("tab");
                $(".tab-content").removeClass("active");

                if (tabId === "color") {
                    $("#color-tab").addClass("active");
                } else if (tabId === "image") {
                    $("#image-tab").addClass("active");
                }
            });

            // 更新背景颜色
            $("#update_bg_color").click(function() {
                const color = $("#bg_color").val();
                updateBackgroundColor(color);
            });

            // 更新背景图片
            $("#update_bg_image").click(function() {
                const customUrl = $("#bg_image_url").val().trim();
                const presetUrl = $("#bg_image_preset").val();

                const imageUrl = customUrl || presetUrl;
                if (imageUrl) {
                    updateBackgroundImage(imageUrl);
                } else {
                    alert("请选择预设图片或输入自定义图片URL");
                }
            });

            // 预设背景选择变化时自动更新
            $("#bg_image_preset").change(function() {
                const presetUrl = $(this).val();
                if (presetUrl) {
                    updateBackgroundImage(presetUrl);
                    $("#bg_image_url").val(''); // 清空自定义URL
                }
            });

            // 窗口大小改变时调整模型大小
            window.addEventListener('resize', function() {
                if (currentModel) {
                    const scale = Math.min(innerWidth / currentModel.width, innerHeight / currentModel.height);
                    currentModel.scale.set(scale);
                    currentModel.y = innerHeight * 0.1;
                    currentModel.x = innerWidth / 2;
                }
            });

            // 确保音频状态显示区域初始化
            updateAudioStatus('等待生成语音...');

            // 加载默认模型
            setTimeout(() => {
                const defaultModel = $("#model_list").val();
                checkAndLoadModel(defaultModel);
            }, 500);

            // 初始化AudioContext（需要用户交互触发）
            function initAudioContext() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        console.log("AudioContext已创建");
                    } catch (error) {
                        console.error("创建AudioContext失败:", error);
                        return false;
                    }
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log("AudioContext已恢复");
                    }).catch(error => {
                        console.error("恢复AudioContext失败:", error);
                    });
                }

                return true;
            }

            // 口型同步设置
            $('#lipsync_enabled, #mouth_intensity, #blink_frequency').on('change input', function() {
                updateLipSyncSettings();
            });

            // 初始化更新一次口型同步设置
            updateLipSyncSettings();
        });

        // 加载可用模型列表
        async function loadAvailableModels() {
            try {
                const response = await fetch('/get_model_list');
                if (!response.ok) {
                    throw new Error('获取模型列表失败');
                }

                const models = await response.json();
                console.log("服务器返回模型列表:", models);

                // 更新模型选择下拉框
                const $modelSelect = $("#model_list");
                $modelSelect.empty();

                models.forEach(model => {
                    modelPaths[model.name] = model.path;
                    modelTypes[model.name] = model.type;
                    $modelSelect.append($("<option>").attr("value", model.name).text(model.name));
                });

                // 如果没有模型，显示提示
                if (models.length === 0) {
                    alert("没有找到可用的Live2D模型，请确保模型文件夹存在并包含有效模型");
                } else {
                    // 加载默认模型
                    setTimeout(() => {
                        const defaultModel = $modelSelect.val();
                        if (defaultModel) {
                            checkAndLoadModel(defaultModel);
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('加载模型列表失败:', error);
                alert('无法加载模型列表，请检查服务器状态');
            }
        }

        // 设置模型更新按钮事件
        function setupModelUpdateButton() {
            $("#update_model").click(function() {
                const selectedModel = $("#model_list").val();
                if (selectedModel) {
                    checkAndLoadModel(selectedModel);
                } else {
                    alert("请选择一个模型");
                }
            });
        }

        // 检查并加载模型
        async function checkAndLoadModel(modelName) {
            try {
                // 停止当前可能正在进行的模型相关活动
                if (currentModel) {
                    stopLipSync();
                    if (expressionTimeout) {
                        clearTimeout(expressionTimeout);
                        expressionTimeout = null;
                    }
                }

                const modelPath = modelPaths[modelName];
                if (!modelPath) {
                    alert(`找不到模型 ${modelName} 的路径配置`);
                    return;
                }

                console.log(`开始验证模型: ${modelName} (${modelPath})`);

                // 验证模型文件
                try {
                    const verifyResponse = await fetch(`/api/verify_model_files/${modelPath}`);
                    const verifyResult = await verifyResponse.json();

                    console.log("模型验证结果:", verifyResult);

                    if (!verifyResult.is_valid) {
                        let missingFiles = verifyResult.missing_files.join("\n- ");
                        alert(`模型 ${modelName} 缺少必要文件:\n- ${missingFiles}`);
                        return;
                    }

                    if (verifyResult.model_type === "cubism2" && modelTypes[modelName] === "cubism4") {
                        alert(`警告: ${modelName} 是Cubism 2格式，但当前配置为使用Cubism 4引擎加载`);
                    }

                    if (verifyResult.model_type === "cubism4" && modelTypes[modelName] === "cubism2") {
                        alert(`警告: ${modelName} 是Cubism 4格式，但当前配置为使用Cubism 2引擎加载`);
                    }

                } catch (verifyError) {
                    console.warn(`验证模型文件失败: ${verifyError.message}, 尝试直接加载模型`);
                }

                // 加载模型 - 只在这一个地方调用loadModel
                console.log(`开始加载模型: ${modelName}`);
                await loadModel(modelName);

            } catch (error) {
                console.error('模型加载过程失败:', error);
                alert(`加载模型 ${modelName} 时出错: ${error.message}`);
            }
        }

        // 检查LFS指针
        async function checkLFSPointers() {
            try {
                const response = await fetch('/api/check_lfs_pointers');
                if (!response.ok) {
                    throw new Error('检查LFS指针失败');
                }

                const result = await response.json();
                console.log("LFS检查结果:", result);

                let html = '';

                if (result.lfs_pointers_found) {
                    html += `<div class="alert alert-danger">
                        <p><strong>发现Git LFS指针文件!</strong></p>
                        <p>您的模型文件是Git LFS指针，而不是实际的模型数据，这就是模型无法加载的原因。</p>
                    </div>`;

                    html += `<h4>受影响的文件：</h4><ul>`;
                    result.files.forEach(file => {
                        html += `<li>${file.path} (当前大小: ${file.size} 字节, 预期大小: ${file.expected_size})</li>`;
                    });
                    html += `</ul>`;

                    html += `<h4>解决方案：</h4>`;

                    if (result.git_lfs_installed) {
                        html += `<p>1. Git LFS已安装，请运行以下命令拉取实际的模型文件：</p>
                        <pre>cd ${result.repo_path}
git lfs pull</pre>`;
                    } else {
                        html += `<p>1. 您需要安装Git LFS并拉取模型文件：</p>
                        <pre># 下载并安装Git LFS: https://git-lfs.github.com/
# 然后运行:
cd ${result.repo_path}
git lfs install
git lfs pull</pre>`;
                    }

                    html += `<p>2. 或者，您可以从Live2D官方网站下载示例模型：</p>
                    <p><a href="https://www.live2d.com/en/download/sample-data/" target="_blank">https://www.live2d.com/en/download/sample-data/</a></p>`;
                } else {
                    html += `<div class="alert alert-success">
                        <p><strong>模型文件检查正常</strong></p>
                        <p>未发现Git LFS指针问题。请检查其他可能导致模型加载失败的因素：</p>
                        <ul>
                            <li>模型格式与引擎版本是否匹配 (Cubism 2 vs Cubism 4)</li>
                            <li>模型文件是否完整且未损坏</li>
                            <li>模型配置文件中的路径是否正确</li>
                        </ul>
                    </div>`;
                }

                // 显示结果
                document.getElementById('lfs_check_result').innerHTML = html;
                document.getElementById('lfs_dialog').style.display = 'block';

            } catch (error) {
                console.error('检查LFS指针失败:', error);
                alert(`检查模型文件失败: ${error.message}`);
            }
        }

        // 处理对话框关闭
        document.querySelector('.close-btn').addEventListener('click', function() {
            document.getElementById('lfs_dialog').style.display = 'none';
        });

        document.getElementById('close_lfs_dialog').addEventListener('click', function() {
            document.getElementById('lfs_dialog').style.display = 'none';
        });

        // 绑定检查按钮事件
        document.getElementById('check_lfs').addEventListener('click', checkLFSPointers);

        // 更新口型同步参数
        function updateLipSyncSettings() {
            const lipSyncEnabled = $('#lipsync_enabled').is(':checked');
            const mouthIntensity = parseFloat($('#mouth_intensity').val());
            const blinkFrequency = $('#blink_frequency').val();

            // 更新嘴巴开合强度
            lipSyncParams.mouthOpenMax = mouthIntensity;
            $('#mouth-value').text(mouthIntensity.toFixed(1));

            // 更新眨眼频率
            switch (blinkFrequency) {
                case 'high':
                    lipSyncParams.blinkInterval = [2000, 4000];
                    break;
                case 'medium':
                    lipSyncParams.blinkInterval = [3000, 7000];
                    break;
                case 'low':
                    lipSyncParams.blinkInterval = [6000, 12000];
                    break;
                case 'none':
                    lipSyncParams.blinkInterval = [1000000, 1000001]; // 实际上禁用眨眼
                    break;
            }

            // 处理启用/禁用状态
            if (!lipSyncEnabled && lipSyncActive) {
                stopLipSync();
            } else if (lipSyncEnabled && currentAudio && !currentAudio.paused && !lipSyncActive) {
                startLipSync();
            }
        }

        // ======== 会话管理 ========
        let currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // ======== RAG 功能 ========
        let ragEnabled = false;
        let knowledgeBaseInfo = {};

        // 初始化RAG功能
        function initRAG() {
            checkRAGStatus();

            // 绑定事件
            $('#rag_enabled').change(function() {
                ragEnabled = $(this).is(':checked');
                if (ragEnabled) {
                    $('#rag_controls').show();
                    loadKnowledgeBase();
                } else {
                    $('#rag_controls').hide();
                }
            });
        }

        // 检查RAG状态
        async function checkRAGStatus() {
            try {
                const response = await fetch('/api/rag/status');
                const data = await response.json();

                if (data.available) {
                    $('#rag_status').html('<span style="color: green;">✓ RAG功能可用</span>');
                    knowledgeBaseInfo = data.knowledge_base_info || {};
                    updateKnowledgeBaseDisplay();
                } else {
                    $('#rag_status').html('<span style="color: red;">✗ RAG功能不可用</span>');
                    $('#rag_enabled').prop('disabled', true);
                }
            } catch (error) {
                console.error('检查RAG状态失败:', error);
                $('#rag_status').html('<span style="color: red;">✗ 无法连接RAG服务</span>');
            }
        }

        // 上传文档
        async function uploadDocument() {
            const fileInput = document.getElementById('document_upload');
            const file = fileInput.files[0];

            if (!file) {
                alert('请选择要上传的文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // 显示进度
            $('#upload_progress').show();
            $('#progress_bar').css('width', '0%');
            $('#progress_text').text('正在上传...');

            try {
                const response = await fetch('/api/rag/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    $('#progress_bar').css('width', '100%');
                    $('#progress_text').text('上传成功！');

                    // 清空文件选择
                    fileInput.value = '';

                    // 刷新知识库信息
                    setTimeout(() => {
                        $('#upload_progress').hide();
                        loadKnowledgeBase();
                    }, 1000);

                    alert('文档上传成功！');
                } else {
                    throw new Error(data.error || '上传失败');
                }
            } catch (error) {
                console.error('上传文档失败:', error);
                $('#progress_text').text('上传失败: ' + error.message);
                setTimeout(() => $('#upload_progress').hide(), 3000);
            }
        }

        // 加载知识库信息
        async function loadKnowledgeBase() {
            try {
                const response = await fetch('/api/rag/knowledge_base');
                const data = await response.json();

                knowledgeBaseInfo = data.knowledge_base || {};
                updateKnowledgeBaseDisplay();
                updateDocumentList(data.uploaded_files || []);

            } catch (error) {
                console.error('加载知识库信息失败:', error);
            }
        }

        // 更新知识库显示
        function updateKnowledgeBaseDisplay() {
            const info = knowledgeBaseInfo;
            const infoHtml = `
                <div>📊 知识库统计:</div>
                <div>• 文档数量: ${info.total_documents || 0}</div>
                <div>• 文本块数: ${info.total_chunks || 0}</div>
                <div>• 源文件: ${(info.source_files || []).length}</div>
            `;
            $('#knowledge_base_info').html(infoHtml);
        }

        // 更新文档列表
        function updateDocumentList(files) {
            let listHtml = '<div style="font-weight: bold; margin-bottom: 5px;">已上传文档:</div>';

            if (files.length === 0) {
                listHtml += '<div style="color: #666;">暂无文档</div>';
            } else {
                files.forEach(file => {
                    listHtml += `
                        <div style="border: 1px solid #ddd; padding: 5px; margin: 3px 0; border-radius: 3px; font-size: 11px;">
                            <div style="font-weight: bold;">${file.original_filename || file.filename}</div>
                            <div>大小: ${file.file_size_mb}MB | 类型: ${file.file_type}</div>
                        </div>
                    `;
                });
            }

            $('#document_list').html(listHtml);
        }

        // 添加消息到对话框
        function appendMessage(sender, message) {
            const timestamp = new Date().toLocaleTimeString();
            const currentText = $('#text_talk').val();
            const newMessage = `[${timestamp}] ${sender}: ${message}\n`;
            $('#text_talk').val(currentText + newMessage);

            // 滚动到底部
            const textArea = document.getElementById('text_talk');
            textArea.scrollTop = textArea.scrollHeight;
        }

        // 更新最后一条消息
        function updateLastMessage(sender, message) {
            const textArea = $('#text_talk');
            const currentText = textArea.val();
            const lines = currentText.split('\n');

            // 找到最后一条来自指定发送者的消息
            let messageUpdated = false;
            for (let i = lines.length - 1; i >= 0; i--) {
                if (lines[i].includes(`] ${sender}: `)) {
                    const timestamp = lines[i].match(/\[(.*?)\]/)?.[1] || new Date().toLocaleTimeString();
                    lines[i] = `[${timestamp}] ${sender}: ${message}`;
                    messageUpdated = true;
                    break;
                }
            }

            // 如果没有找到要更新的消息，添加新消息
            if (!messageUpdated) {
                const timestamp = new Date().toLocaleTimeString();
                lines.push(`[${timestamp}] ${sender}: ${message}`);
            }

            textArea.val(lines.join('\n'));
            textArea.scrollTop(textArea[0].scrollHeight);
        }

        // 搜索文档
        async function searchDocuments() {
            const query = $('#search_query').val().trim();
            if (!query) {
                alert('请输入搜索内容');
                return;
            }

            try {
                const response = await fetch('/api/rag/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query, k: 3 })
                });

                const data = await response.json();

                let resultsHtml = `<div style="font-weight: bold;">搜索结果 (${data.count}):</div>`;

                if (data.results && data.results.length > 0) {
                    data.results.forEach((result, index) => {
                        resultsHtml += `
                            <div style="border: 1px solid #ddd; padding: 5px; margin: 3px 0; border-radius: 3px;">
                                <div style="font-weight: bold; font-size: 10px;">来源: ${result.source}</div>
                                <div style="font-size: 10px;">${result.content.substring(0, 100)}...</div>
                            </div>
                        `;
                    });
                } else {
                    resultsHtml += '<div style="color: #666;">未找到相关内容</div>';
                }

                $('#search_results').html(resultsHtml);

            } catch (error) {
                console.error('搜索失败:', error);
                $('#search_results').html('<div style="color: red;">搜索失败</div>');
            }
        }

        // 修改发送消息函数以支持RAG
        function sendMessage(message) {
            const userInput = message || $('#user_input').val().trim();
            if (!userInput) return;

            const modelName = $('#llm_model').val();
            const temperature = parseFloat($('#temperature').val());
            const topP = parseFloat($('#top_p').val());
            const rolePrompt = $('#role_prompt').val();
            const voiceId = $('#voice_selection').val();

            // 禁用发送按钮，显示加载状态
            $('#send_message').prop('disabled', true);

            // 清空输入框
            $('#user_input').val('');

            // 显示用户消息
            appendMessage('用户', userInput);

            // 设置思考表情和动作
            setModelExpression('疑惑');
            playModelMotion('思考');

            // 准备请求数据
            const requestData = {
                session_id: currentSessionId,
                prompt: userInput,
                role_prompt: rolePrompt,
                model_name: modelName,
                temperature: temperature,
                top_p: topP,
                voice_id: voiceId,
                use_rag: ragEnabled
            };

            // 选择API端点
            const endpoint = ragEnabled ? '/rag_generate' : '/generate';

            // 发送请求
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.body.getReader();
            })
            .then(reader => {
                let assistantMessage = '';
                let retrievedDocs = [];
                let messageInitialized = false;

                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) return;

                        const chunk = new TextDecoder().decode(value);
                        const lines = chunk.split('\n');

                        let streamShouldContinue = true;

                        for (const line of lines) {
                            if (line.trim()) {
                                try {
                                    const data = JSON.parse(line);

                                    if (data.type === 'retrieved_docs') {
                                        // 显示检索到的文档
                                        retrievedDocs = data.docs;
                                        if (retrievedDocs.length > 0) {
                                            let docsHtml = '<div style="background: #f0f8ff; padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 11px;">';
                                            docsHtml += '<strong>📚 参考文档:</strong><br>';
                                            retrievedDocs.forEach(doc => {
                                                docsHtml += `• ${doc.source}: ${doc.content}<br>`;
                                            });
                                            docsHtml += '</div>';
                                            $('#text_talk').append(docsHtml);
                                            $('#text_talk').scrollTop($('#text_talk')[0].scrollHeight);
                                        }
                                    } else if (data.type === 'emotion_analysis') {
                                        // 处理情感分析结果
                                        handleEmotionAnalysis(data.emotion_data);
                                    } else if (data.chunk && !data.done) {
                                        assistantMessage += data.chunk;

                                        // 只在第一次收到chunk时创建消息
                                        if (!messageInitialized) {
                                            appendMessage('AI助手', assistantMessage);
                                            messageInitialized = true;
                                        } else {
                                            updateLastMessage('AI助手', assistantMessage);
                                        }
                                    } else if (data.done === true) {
                                        if (data.audio_url) {
                                            currentAudioUrl = data.audio_url;
                                            lastAudioUrl = data.audio_url;
                                            $('#play_audio').prop('disabled', false);
                                            enableAudioControls(true);
                                            updateAudioStatus('语音生成完成');
                                            playAudio(); // 自动播放
                                        } else {
                                            updateAudioStatus('未生成语音');
                                        }

                                        // 处理情感分析结果
                                        if (data.user_emotion) {
                                            handleEmotionAnalysis(data.user_emotion);
                                        }
                                        if (data.ai_emotion) {
                                            handleEmotionAnalysis(data.ai_emotion);
                                        }

                                        // 应用Live2D参数
                                        if (data.live2d_parameters) {
                                            applyLive2DParameters(data.live2d_parameters);
                                        }

                                        // 分析响应文本，设置表情和动作
                                        analyzeEmotionAndPlayAction(assistantMessage);

                                        // 显示RAG使用信息
                                        if (data.used_rag && data.retrieved_docs_count > 0) {
                                            const ragInfo = `\n<small style="color: #666;">[使用了 ${data.retrieved_docs_count} 个文档片段]</small>`;
                                            updateLastMessage('AI助手', assistantMessage + ragInfo);
                                        }

                                        // 恢复按钮状态
                                        $('#send_message').prop('disabled', false);

                                        // 停止流处理，直接返回
                                        return;
                                    }
                                } catch (e) {
                                    console.error('解析响应失败:', e);
                                }
                            }
                        }

                        // 继续读取下一个chunk
                        if (!done) {
                            return readStream();
                        }
                    });
                }

                // 开始读取流
                return readStream();
            })
            .catch(error => {
                console.error('发送消息失败:', error);
                appendMessage('系统', '发送消息失败: ' + error.message);

                // 恢复按钮状态
                $('#send_message').prop('disabled', false);

                // 设置悲伤表情
                setModelExpression('悲伤');
            });
        }

        // ======== 高级情感系统功能 ========
        let advancedEmotionEnabled = true;
        let currentEmotionState = {
            emotion_type: 'neutral',
            intensity: 0.1,
            is_transitioning: false
        };

        // 初始化高级情感系统
        function initAdvancedEmotionSystem() {
            checkEmotionSystemStatus();

            // 绑定事件
            $('#advanced_emotion_enabled').change(function() {
                advancedEmotionEnabled = $(this).is(':checked');
                if (advancedEmotionEnabled) {
                    startEmotionParameterUpdates();
                } else {
                    stopEmotionParameterUpdates();
                }
            });

            // 启动参数更新循环
            if (advancedEmotionEnabled) {
                startEmotionParameterUpdates();
            }
        }

        // 检查情感系统状态
        async function checkEmotionSystemStatus() {
            try {
                const response = await fetch('/api/emotion/status');
                const data = await response.json();

                if (data.available) {
                    $('#emotion_system_status').html('<span style="color: green;">✓ 高级情感系统可用</span>');
                    updateEmotionDisplay(data.status.current_emotion);
                } else {
                    $('#emotion_system_status').html('<span style="color: red;">✗ 高级情感系统不可用</span>');
                    $('#advanced_emotion_enabled').prop('disabled', true);
                }
            } catch (error) {
                console.error('检查情感系统状态失败:', error);
                $('#emotion_system_status').html('<span style="color: red;">✗ 无法连接情感系统</span>');
            }
        }

        // 更新情感状态显示
        function updateEmotionDisplay(emotionState) {
            if (!emotionState) return;

            currentEmotionState = emotionState;

            $('#emotion_type_display').text(`${emotionState.emotion_label || emotionState.emotion_type}`);
            $('#emotion_intensity_display').text(`强度: ${emotionState.intensity_label || '未知'} (${(emotionState.intensity * 100).toFixed(0)}%)`);

            if (emotionState.is_transitioning && emotionState.transition_info) {
                const transition = emotionState.transition_info;
                $('#emotion_transition_display').text(`转换中: ${transition.from_emotion} → ${transition.to_emotion} (${(transition.progress * 100).toFixed(0)}%)`);
            } else {
                $('#emotion_transition_display').text('');
            }
        }

        // 手动设置情感
        async function setManualEmotion() {
            if (!advancedEmotionEnabled) return;

            const emotionType = $('#manual_emotion_type').val();
            const intensity = parseFloat($('#manual_emotion_intensity').val());

            try {
                const response = await fetch('/api/emotion/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emotion_type: emotionType,
                        intensity: intensity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    updateEmotionDisplay(data.current_state);
                    // 应用Live2D参数
                    if (data.live2d_parameters) {
                        applyLive2DParameters(data.live2d_parameters);
                    }
                } else {
                    console.error('设置情感失败:', data.error);
                }

            } catch (error) {
                console.error('设置情感失败:', error);
            }
        }

        // 触发手势
        async function triggerGesture() {
            if (!advancedEmotionEnabled) return;

            const gestureName = $('#gesture_type').val();

            try {
                const response = await fetch('/api/emotion/gesture', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gesture_name: gestureName
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`触发手势成功: ${gestureName}`);
                } else {
                    console.error('触发手势失败:', data.error);
                }

            } catch (error) {
                console.error('触发手势失败:', error);
            }
        }

        // 显示情感历史
        async function showEmotionHistory() {
            try {
                const response = await fetch('/api/emotion/history?limit=10');
                const data = await response.json();

                if (data.success) {
                    let historyHtml = '<div style="font-weight: bold; margin-bottom: 5px;">情感历史:</div>';

                    data.history.forEach(item => {
                        const time = new Date(item.timestamp * 1000).toLocaleTimeString();
                        historyHtml += `
                            <div style="border: 1px solid #ddd; padding: 3px; margin: 2px 0; border-radius: 3px;">
                                <div style="font-size: 10px; color: #666;">${time}</div>
                                <div>${item.emotion_label} - ${(item.intensity * 100).toFixed(0)}%</div>
                            </div>
                        `;
                    });

                    $('#emotion_history_display').html(historyHtml).show();
                } else {
                    console.error('获取情感历史失败:', data.error);
                }

            } catch (error) {
                console.error('获取情感历史失败:', error);
            }
        }

        // 重置情感状态
        async function resetEmotion() {
            try {
                const response = await fetch('/api/emotion/reset', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    updateEmotionDisplay(data.current_state);
                    console.log('情感状态已重置');
                } else {
                    console.error('重置情感状态失败:', data.error);
                }

            } catch (error) {
                console.error('重置情感状态失败:', error);
            }
        }

        // 应用Live2D参数
        function applyLive2DParameters(parameters) {
            if (!currentModel) return;

            try {
                for (const [paramName, value] of Object.entries(parameters)) {
                    if (currentModel.getParameterIndex && currentModel.setParameterValueByIndex) {
                        const paramIndex = currentModel.getParameterIndex(paramName);
                        if (paramIndex >= 0) {
                            currentModel.setParameterValueByIndex(paramIndex, value);
                        }
                    }
                }
            } catch (error) {
                console.error('应用Live2D参数失败:', error);
            }
        }

        // 启动情感参数更新循环
        function startEmotionParameterUpdates() {
            if (window.emotionUpdateInterval) {
                clearInterval(window.emotionUpdateInterval);
            }

            window.emotionUpdateInterval = setInterval(async () => {
                if (!advancedEmotionEnabled) return;

                try {
                    const response = await fetch('/api/emotion/parameters');
                    const data = await response.json();

                    if (data.success) {
                        applyLive2DParameters(data.parameters);
                    }
                } catch (error) {
                    // 静默处理错误，避免控制台刷屏
                }
            }, 1000); // 1 FPS更新频率，减少服务器负载
        }

        // 停止情感参数更新
        function stopEmotionParameterUpdates() {
            if (window.emotionUpdateInterval) {
                clearInterval(window.emotionUpdateInterval);
                window.emotionUpdateInterval = null;
            }
        }

        // 处理情感分析结果
        function handleEmotionAnalysis(emotionData) {
            if (!advancedEmotionEnabled || !emotionData) return;

            // 更新情感显示
            if (emotionData.current_state) {
                updateEmotionDisplay(emotionData.current_state);
            }

            // 显示情感分析结果
            if (emotionData.emotion_analysis) {
                const analysis = emotionData.emotion_analysis;
                console.log(`情感分析: ${analysis.emotion_label}, 强度: ${analysis.intensity_label}`);
            }
        }

        // ======== 多模态AI系统功能 ========
        let multimodalEnabled = false;
        let uploadedImages = {};

        // 初始化多模态系统
        function initMultimodalSystem() {
            checkMultimodalStatus();

            // 绑定事件
            $('#multimodal_enabled').change(function() {
                multimodalEnabled = $(this).is(':checked');
                if (multimodalEnabled) {
                    $('#multimodal_controls').show();
                    loadUploadedImages();
                } else {
                    $('#multimodal_controls').hide();
                }
            });
        }

        // 检查多模态系统状态
        async function checkMultimodalStatus() {
            try {
                const response = await fetch('/api/multimodal/status');
                const data = await response.json();

                if (data.available) {
                    $('#multimodal_status').html('<span style="color: green;">✓ 多模态AI系统可用</span>');
                } else {
                    $('#multimodal_status').html('<span style="color: red;">✗ 多模态AI系统不可用</span>');
                    $('#multimodal_enabled').prop('disabled', true);
                }
            } catch (error) {
                console.error('检查多模态系统状态失败:', error);
                $('#multimodal_status').html('<span style="color: red;">✗ 无法连接多模态系统</span>');
            }
        }

        // 上传图像
        async function uploadImage() {
            const fileInput = document.getElementById('image_upload');
            const file = fileInput.files[0];

            if (!file) {
                alert('请选择要上传的图像文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('add_to_knowledge_base', 'true');

            // 显示进度
            $('#image_upload_progress').show();
            $('#image_progress_bar').css('width', '0%');
            $('#image_progress_text').text('正在上传...');

            try {
                const response = await fetch('/api/multimodal/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    $('#image_progress_bar').css('width', '100%');
                    $('#image_progress_text').text('上传成功！');

                    // 清空文件选择
                    fileInput.value = '';

                    // 刷新图像列表
                    setTimeout(() => {
                        $('#image_upload_progress').hide();
                        loadUploadedImages();
                    }, 1000);

                    alert('图像上传成功！');
                } else {
                    throw new Error(data.error || '上传失败');
                }
            } catch (error) {
                console.error('上传图像失败:', error);
                $('#image_progress_text').text('上传失败: ' + error.message);
                setTimeout(() => $('#image_upload_progress').hide(), 3000);
            }
        }

        // 加载已上传的图像
        async function loadUploadedImages() {
            try {
                const response = await fetch('/api/multimodal/images');
                const data = await response.json();

                if (data.success) {
                    uploadedImages = {};
                    let imagesHtml = '<div style="font-weight: bold; margin-bottom: 5px;">已上传图像:</div>';

                    if (data.images.length === 0) {
                        imagesHtml += '<div style="color: #666;">暂无图像</div>';
                    } else {
                        data.images.forEach(image => {
                            uploadedImages[image.image_id] = image;
                            imagesHtml += `
                                <div style="border: 1px solid #ddd; padding: 5px; margin: 3px 0; border-radius: 3px; font-size: 11px;">
                                    <div style="font-weight: bold;">${image.filename}</div>
                                    <div>${image.description.substring(0, 50)}...</div>
                                    <div style="color: #666;">${image.analysis_summary}</div>
                                    <button onclick="deleteImage('${image.image_id}')" style="font-size: 10px; margin-top: 3px;">删除</button>
                                </div>
                            `;
                        });
                    }

                    $('#uploaded_images').html(imagesHtml);
                    updateImageSelectors(data.images);
                }

            } catch (error) {
                console.error('加载图像列表失败:', error);
            }
        }

        // 更新图像选择器
        function updateImageSelectors(images) {
            const selectors = ['#selected_image_id', '#compare_image1', '#compare_image2'];

            selectors.forEach(selector => {
                const $select = $(selector);
                $select.empty();
                $select.append('<option value="">请选择图像</option>');

                images.forEach(image => {
                    $select.append(`<option value="${image.image_id}">${image.filename}</option>`);
                });
            });
        }

        // 分析选中的图像
        async function analyzeSelectedImage() {
            const imageId = $('#selected_image_id').val();
            if (!imageId) {
                alert('请先选择一个图像');
                return;
            }

            try {
                const response = await fetch('/api/multimodal/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_id: imageId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const image = uploadedImages[imageId];
                    let analysisHtml = `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <h4>${image.filename} 分析结果</h4>
                            <p><strong>描述:</strong> ${data.description || '无描述'}</p>
                    `;

                    if (data.analysis && data.analysis.success) {
                        const analysis = data.analysis;
                        if (analysis.objects && analysis.objects.length > 0) {
                            analysisHtml += `<p><strong>识别物体:</strong> ${analysis.objects.join(', ')}</p>`;
                        }
                        if (analysis.emotions && analysis.emotions.length > 0) {
                            analysisHtml += `<p><strong>情感:</strong> ${analysis.emotions.join(', ')}</p>`;
                        }
                        if (analysis.scene) {
                            analysisHtml += `<p><strong>场景:</strong> ${analysis.scene}</p>`;
                        }
                    }

                    analysisHtml += '</div>';

                    // 显示在对话框中
                    appendMessage('系统', analysisHtml);
                } else {
                    alert('图像分析失败: ' + data.error);
                }

            } catch (error) {
                console.error('图像分析失败:', error);
                alert('图像分析失败');
            }
        }

        // 对图像提问
        async function askImageQuestion() {
            const imageId = $('#selected_image_id').val();
            const question = $('#image_question').val().trim();

            if (!imageId) {
                alert('请先选择一个图像');
                return;
            }

            if (!question) {
                alert('请输入问题');
                return;
            }

            try {
                const response = await fetch('/api/multimodal/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_id: imageId,
                        question: question
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const image = uploadedImages[imageId];
                    const questionHtml = `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <h4>图像问答</h4>
                            <p><strong>图像:</strong> ${image.filename}</p>
                            <p><strong>问题:</strong> ${question}</p>
                            <p><strong>回答:</strong> ${data.answer}</p>
                        </div>
                    `;

                    // 显示在对话框中
                    appendMessage('系统', questionHtml);

                    // 清空问题输入
                    $('#image_question').val('');
                } else {
                    alert('图像问答失败: ' + data.error);
                }

            } catch (error) {
                console.error('图像问答失败:', error);
                alert('图像问答失败');
            }
        }

        // 多模态搜索
        async function searchMultimodal() {
            const query = $('#multimodal_search_query').val().trim();
            const searchType = $('#search_type').val();

            if (!query) {
                alert('请输入搜索内容');
                return;
            }

            try {
                const response = await fetch('/api/multimodal/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        search_type: searchType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let resultsHtml = `<div style="font-weight: bold; margin-bottom: 5px;">搜索结果 (${data.result_count}条):</div>`;

                    if (data.results.length === 0) {
                        resultsHtml += '<div style="color: #666;">未找到相关内容</div>';
                    } else {
                        data.results.forEach((result, index) => {
                            const typeLabel = result.type === 'image' ? '图像' : result.type === 'image_text' ? '图文' : '文本';
                            resultsHtml += `
                                <div style="border: 1px solid #ddd; padding: 5px; margin: 3px 0; border-radius: 3px;">
                                    <div style="font-weight: bold; color: #333;">[${typeLabel}] ${result.metadata.filename || '未知文件'}</div>
                                    <div style="font-size: 10px;">${result.content.substring(0, 100)}...</div>
                                    <div style="font-size: 9px; color: #666;">相关度: ${(result.relevance_score * 100).toFixed(0)}%</div>
                                </div>
                            `;
                        });
                    }

                    $('#multimodal_search_results').html(resultsHtml);

                    // 显示AI回答
                    if (data.response) {
                        const responseHtml = `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                                <h4>多模态搜索回答</h4>
                                <p><strong>问题:</strong> ${query}</p>
                                <p><strong>回答:</strong> ${data.response}</p>
                            </div>
                        `;
                        appendMessage('系统', responseHtml);
                    }
                } else {
                    alert('搜索失败: ' + data.error);
                }

            } catch (error) {
                console.error('多模态搜索失败:', error);
                alert('搜索失败');
            }
        }

        // 比较图像
        async function compareImages() {
            const imageId1 = $('#compare_image1').val();
            const imageId2 = $('#compare_image2').val();

            if (!imageId1 || !imageId2) {
                alert('请选择两个要比较的图像');
                return;
            }

            if (imageId1 === imageId2) {
                alert('请选择不同的图像进行比较');
                return;
            }

            try {
                const response = await fetch('/api/multimodal/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_id1: imageId1,
                        image_id2: imageId2,
                        comparison_aspect: '整体相似性'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const image1 = uploadedImages[imageId1];
                    const image2 = uploadedImages[imageId2];
                    const similarity = (data.overall_similarity * 100).toFixed(1);

                    let comparisonHtml = `
                        <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 4px;">
                            <div style="font-weight: bold;">图像比较结果</div>
                            <div style="font-size: 11px;">
                                <div>图像1: ${image1.filename}</div>
                                <div>图像2: ${image2.filename}</div>
                                <div style="color: #333; margin-top: 5px;">
                                    相似度: <span style="font-weight: bold; color: ${similarity > 70 ? 'green' : similarity > 40 ? 'orange' : 'red'};">${similarity}%</span>
                                </div>
                    `;

                    if (data.vlm_comparison && data.vlm_comparison.comparison_result) {
                        comparisonHtml += `<div style="margin-top: 5px;">分析: ${data.vlm_comparison.comparison_result}</div>`;
                    }

                    comparisonHtml += '</div></div>';

                    $('#image_comparison_result').html(comparisonHtml);
                } else {
                    alert('图像比较失败: ' + data.error);
                }

            } catch (error) {
                console.error('图像比较失败:', error);
                alert('图像比较失败');
            }
        }

        // 删除图像
        async function deleteImage(imageId) {
            if (!confirm('确定要删除这张图像吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/multimodal/images/${imageId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('图像删除成功');
                    loadUploadedImages();
                } else {
                    alert('删除失败: ' + data.error);
                }

            } catch (error) {
                console.error('删除图像失败:', error);
                alert('删除失败');
            }
        }

        // ======== 语音情感系统功能 ========
        let voiceEmotionEnabled = false;
        let voiceTasks = {};

        // 初始化语音情感系统
        function initVoiceEmotionSystem() {
            checkVoiceEmotionStatus();

            // 绑定事件
            $('#voice_emotion_enabled').change(function() {
                voiceEmotionEnabled = $(this).is(':checked');
                if (voiceEmotionEnabled) {
                    $('#voice_emotion_controls').show();
                    loadVoiceSettings();
                } else {
                    $('#voice_emotion_controls').hide();
                }
            });

            // 绑定滑块事件
            $('#emotion_intensity').on('input', function() {
                $('#emotion_intensity_value').text($(this).val());
            });

            $('#emotion_sensitivity').on('input', function() {
                $('#emotion_sensitivity_value').text($(this).val());
            });
        }

        // 检查语音情感系统状态
        async function checkVoiceEmotionStatus() {
            try {
                const response = await fetch('/api/voice/status');
                const data = await response.json();

                if (data.available) {
                    $('#voice_emotion_status').html('<span style="color: green;">✓ 语音情感系统可用</span>');
                    updateVoiceStatistics(data.status);
                } else {
                    $('#voice_emotion_status').html('<span style="color: red;">✗ 语音情感系统不可用</span>');
                    $('#voice_emotion_enabled').prop('disabled', true);
                }
            } catch (error) {
                console.error('检查语音情感系统状态失败:', error);
                $('#voice_emotion_status').html('<span style="color: red;">✗ 无法连接语音情感系统</span>');
            }
        }

        // 加载语音设置
        async function loadVoiceSettings() {
            try {
                // 加载可用语音
                const voicesResponse = await fetch('/api/voice/voices');
                const voicesData = await voicesResponse.json();

                // 加载可用风格
                const stylesResponse = await fetch('/api/voice/styles');
                const stylesData = await stylesResponse.json();

                // 更新界面
                updateVoiceSelectors(voicesData, stylesData);

            } catch (error) {
                console.error('加载语音设置失败:', error);
            }
        }

        // 更新语音选择器
        function updateVoiceSelectors(voicesData, stylesData) {
            // 更新风格选择器
            const $styleSelect = $('#voice_style_select');
            $styleSelect.empty();

            if (stylesData.styles) {
                Object.keys(stylesData.styles).forEach(styleName => {
                    const style = stylesData.styles[styleName];
                    $styleSelect.append(`<option value="${styleName}">${style.name}</option>`);
                });
            }

            // 设置当前风格
            if (stylesData.current_style) {
                $styleSelect.val(stylesData.current_style);
            }
        }

        // 设置语音风格
        async function setVoiceStyle() {
            const styleName = $('#voice_style_select').val();

            try {
                const response = await fetch('/api/voice/style', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        style_name: styleName
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('语音风格设置成功: ' + data.description, 'success');
                } else {
                    showMessage('语音风格设置失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('设置语音风格失败:', error);
                showMessage('设置语音风格失败', 'error');
            }
        }

        // 设置语音角色
        async function setVoiceCharacter() {
            const voiceName = $('#voice_character_select').val();
            const language = $('#voice_language_select').val();

            try {
                const response = await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        voice_name: voiceName,
                        language: language
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('语音角色设置成功', 'success');
                } else {
                    showMessage('语音角色设置失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('设置语音角色失败:', error);
                showMessage('设置语音角色失败', 'error');
            }
        }

        // 设置情感敏感度
        async function setEmotionSensitivity() {
            const sensitivity = parseFloat($('#emotion_sensitivity').val());

            try {
                const response = await fetch('/api/voice/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emotion_sensitivity: sensitivity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('情感敏感度设置成功', 'success');
                } else {
                    showMessage('情感敏感度设置失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('设置情感敏感度失败:', error);
                showMessage('设置情感敏感度失败', 'error');
            }
        }

        // 测试语音合成
        async function testVoiceSynthesis() {
            const text = $('#voice_test_text').val().trim();
            const emotion = $('#emotion_type_select').val();
            const intensity = parseFloat($('#emotion_intensity').val());

            if (!text) {
                showMessage('请输入测试文本', 'warning');
                return;
            }

            try {
                showMessage('正在合成语音...', 'info');

                const response = await fetch('/api/voice/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        emotion: emotion,
                        intensity: intensity,
                        realtime: false,
                        auto_play: $('#auto_play_voice').is(':checked')
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('语音合成成功', 'success');

                    // 显示合成信息
                    const infoHtml = `
                        <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 11px;">
                            <div><strong>语音合成完成</strong></div>
                            <div>情感: ${data.emotion} (强度: ${data.intensity})</div>
                            <div>语音: ${data.voice_name} (${data.language})</div>
                            <div>时长: ${data.duration ? data.duration.toFixed(1) + 's' : '未知'}</div>
                        </div>
                    `;

                    $('#voice_task_status').prepend(infoHtml);
                } else {
                    showMessage('语音合成失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('语音合成测试失败:', error);
                showMessage('语音合成测试失败', 'error');
            }
        }

        // 实时语音合成
        async function synthesizeRealtime() {
            const text = $('#voice_test_text').val().trim();
            const emotion = $('#emotion_type_select').val();
            const intensity = parseFloat($('#emotion_intensity').val());

            if (!text) {
                showMessage('请输入测试文本', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/voice/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        emotion: emotion,
                        intensity: intensity,
                        realtime: true,
                        auto_play: $('#auto_play_voice').is(':checked')
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('实时合成任务已提交', 'success');

                    // 添加任务到监控列表
                    voiceTasks[data.task_id] = {
                        text: text,
                        emotion: emotion,
                        intensity: intensity,
                        status: 'pending',
                        created_at: new Date()
                    };

                    // 开始监控任务
                    monitorVoiceTask(data.task_id);

                    // 更新任务显示
                    updateVoiceTaskDisplay();
                } else {
                    showMessage('实时合成失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('实时语音合成失败:', error);
                showMessage('实时语音合成失败', 'error');
            }
        }

        // 监控语音任务
        async function monitorVoiceTask(taskId) {
            const maxAttempts = 30; // 最多监控30次
            let attempts = 0;

            const checkTask = async () => {
                try {
                    const response = await fetch(`/api/voice/task/${taskId}`);
                    const data = await response.json();

                    if (voiceTasks[taskId]) {
                        voiceTasks[taskId].status = data.status;

                        if (data.status === 'completed') {
                            voiceTasks[taskId].result = data.result;
                            showMessage('语音合成完成', 'success');
                            updateVoiceTaskDisplay();
                            return;
                        } else if (data.status === 'failed') {
                            voiceTasks[taskId].error = data.error;
                            showMessage('语音合成失败: ' + data.error, 'error');
                            updateVoiceTaskDisplay();
                            return;
                        }
                    }

                    attempts++;
                    if (attempts < maxAttempts && data.status === 'processing') {
                        setTimeout(checkTask, 1000); // 1秒后再次检查
                    } else if (attempts >= maxAttempts) {
                        showMessage('任务监控超时', 'warning');
                    }

                    updateVoiceTaskDisplay();

                } catch (error) {
                    console.error('监控任务失败:', error);
                }
            };

            checkTask();
        }

        // 更新任务显示
        function updateVoiceTaskDisplay() {
            let tasksHtml = '<div style="font-weight: bold; margin-bottom: 5px;">语音任务状态:</div>';

            const taskIds = Object.keys(voiceTasks).slice(-5); // 只显示最近5个任务

            if (taskIds.length === 0) {
                tasksHtml += '<div style="color: #666;">暂无任务</div>';
            } else {
                taskIds.forEach(taskId => {
                    const task = voiceTasks[taskId];
                    const statusColor = {
                        'pending': '#orange',
                        'processing': '#blue',
                        'completed': '#green',
                        'failed': '#red',
                        'cancelled': '#gray'
                    }[task.status] || '#black';

                    tasksHtml += `
                        <div style="border: 1px solid #ddd; padding: 3px; margin: 2px 0; border-radius: 3px;">
                            <div style="font-size: 10px;">
                                <span style="color: ${statusColor};">●</span> ${task.text.substring(0, 20)}...
                                <span style="float: right;">${task.status}</span>
                            </div>
                        </div>
                    `;
                });
            }

            $('#voice_task_status').html(tasksHtml);
        }

        // 更新语音统计信息
        function updateVoiceStatistics(status) {
            if (!status) return;

            let statsHtml = '<div style="font-weight: bold;">系统统计:</div>';

            if (status.synthesizer_stats) {
                const stats = status.synthesizer_stats;
                statsHtml += `
                    <div>缓存: ${stats.cache_size} 项</div>
                    <div>当前语音: ${stats.current_voice}</div>
                    <div>当前情感: ${stats.current_emotion}</div>
                `;
            }

            if (status.realtime_processor) {
                const processor = status.realtime_processor;
                statsHtml += `
                    <div>队列任务: ${processor.pending_tasks}</div>
                    <div>处理中: ${processor.processing_tasks}</div>
                    <div>已完成: ${processor.completed_tasks}</div>
                `;
            }

            $('#voice_statistics').html(statsHtml);
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            const colors = {
                'success': '#4CAF50',
                'error': '#f44336',
                'warning': '#ff9800',
                'info': '#2196F3'
            };

            const messageHtml = `
                <div style="background: ${colors[type]}; color: white; padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 12px;">
                    ${message}
                </div>
            `;

            // 添加到对话框
            appendMessage('系统', messageHtml);
        }

        // ======== 高级RAG系统功能 ========
        let advancedRAGEnabled = false;

        // 初始化高级RAG系统
        function initAdvancedRAGSystem() {
            checkAdvancedRAGStatus();

            // 绑定事件
            $('#advanced_rag_enabled').change(function() {
                advancedRAGEnabled = $(this).is(':checked');
                if (advancedRAGEnabled) {
                    $('#advanced_rag_controls').show();
                    loadAdvancedRAGSettings();
                } else {
                    $('#advanced_rag_controls').hide();
                }
            });
        }

        // 检查高级RAG系统状态
        async function checkAdvancedRAGStatus() {
            try {
                const response = await fetch('/api/advanced-rag/status');
                const data = await response.json();

                if (data.available) {
                    $('#advanced_rag_status').html('<span style="color: green;">✓ 高级RAG系统可用</span>');
                    updateAdvancedRAGStatistics(data.status);
                } else {
                    $('#advanced_rag_status').html('<span style="color: red;">✗ 高级RAG系统不可用</span>');
                    $('#advanced_rag_enabled').prop('disabled', true);
                }
            } catch (error) {
                console.error('检查高级RAG系统状态失败:', error);
                $('#advanced_rag_status').html('<span style="color: red;">✗ 无法连接高级RAG系统</span>');
            }
        }

        // 加载高级RAG设置
        async function loadAdvancedRAGSettings() {
            try {
                // 设置默认值
                $('#include_reasoning').prop('checked', true);
                $('#enable_fusion').prop('checked', true);
                $('#multimodal_mode').prop('checked', false);

            } catch (error) {
                console.error('加载高级RAG设置失败:', error);
            }
        }

        // 处理高级文档
        async function processAdvancedDocument() {
            const text = $('#advanced_doc_text').val().trim();
            const docId = $('#advanced_doc_id').val().trim();
            const imagePath = $('#advanced_image_path').val().trim();

            if (!text) {
                showAdvancedRAGMessage('请输入文档内容', 'warning');
                return;
            }

            try {
                showAdvancedRAGMessage('正在处理文档...', 'info');

                const response = await fetch('/api/advanced-rag/process-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        doc_id: docId || undefined,
                        image_path: imagePath || undefined,
                        metadata: {
                            processed_at: new Date().toISOString(),
                            source: 'web_interface'
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAdvancedRAGMessage('文档处理成功', 'success');
                    displayAdvancedRAGResult('文档处理', data);

                    // 清空输入
                    $('#advanced_doc_text').val('');
                    $('#advanced_doc_id').val('');
                    $('#advanced_image_path').val('');
                } else {
                    showAdvancedRAGMessage('文档处理失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('文档处理失败:', error);
                showAdvancedRAGMessage('文档处理失败', 'error');
            }
        }

        // 执行高级查询
        async function executeAdvancedQuery() {
            const query = $('#advanced_query_text').val().trim();
            const queryType = $('#advanced_query_type').val();
            const includeReasoning = $('#include_reasoning').is(':checked');

            if (!query) {
                showAdvancedRAGMessage('请输入查询问题', 'warning');
                return;
            }

            try {
                showAdvancedRAGMessage('正在执行高级查询...', 'info');

                const response = await fetch('/api/advanced-rag/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        query_type: queryType,
                        max_results: 10,
                        include_reasoning: includeReasoning
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAdvancedRAGMessage('查询执行成功', 'success');
                    displayAdvancedRAGResult('高级查询', data);

                    // 显示融合答案
                    if (data.fused_answer) {
                        appendMessage('AI助手', data.fused_answer);
                    }
                } else {
                    showAdvancedRAGMessage('查询执行失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('高级查询失败:', error);
                showAdvancedRAGMessage('高级查询失败', 'error');
            }
        }

        // 执行多模态推理
        async function executeMultimodalReasoning() {
            const query = $('#reasoning_query').val().trim();
            const reasoningType = $('#reasoning_type').val();
            const imagePath = $('#advanced_image_path').val().trim();

            if (!query) {
                showAdvancedRAGMessage('请输入推理问题', 'warning');
                return;
            }

            try {
                showAdvancedRAGMessage('正在执行多模态推理...', 'info');

                const response = await fetch('/api/advanced-rag/reasoning', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        reasoning_type: reasoningType,
                        image_path: imagePath || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAdvancedRAGMessage('推理执行成功', 'success');
                    displayAdvancedRAGResult('多模态推理', data);

                    // 显示推理结果
                    if (data.reasoning_result && data.reasoning_result.answer) {
                        appendMessage('AI推理', data.reasoning_result.answer);
                    }
                } else {
                    showAdvancedRAGMessage('推理执行失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('多模态推理失败:', error);
                showAdvancedRAGMessage('多模态推理失败', 'error');
            }
        }

        // 构建知识图谱
        async function buildKnowledgeGraph() {
            const text = $('#advanced_doc_text').val().trim();
            const docId = $('#advanced_doc_id').val().trim();

            if (!text) {
                showAdvancedRAGMessage('请输入文档内容来构建图谱', 'warning');
                return;
            }

            try {
                showAdvancedRAGMessage('正在构建知识图谱...', 'info');

                const response = await fetch('/api/advanced-rag/build-graph', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        doc_id: docId || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAdvancedRAGMessage('知识图谱构建成功', 'success');
                    displayAdvancedRAGResult('知识图谱构建', data);
                } else {
                    showAdvancedRAGMessage('知识图谱构建失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('知识图谱构建失败:', error);
                showAdvancedRAGMessage('知识图谱构建失败', 'error');
            }
        }

        // 获取图谱统计
        async function getGraphStats() {
            try {
                const response = await fetch('/api/advanced-rag/graph-stats');
                const data = await response.json();

                showAdvancedRAGMessage('图谱统计获取成功', 'success');
                displayAdvancedRAGResult('图谱统计', data);

            } catch (error) {
                console.error('获取图谱统计失败:', error);
                showAdvancedRAGMessage('获取图谱统计失败', 'error');
            }
        }

        // 清理高级缓存
        async function clearAdvancedCaches() {
            try {
                const response = await fetch('/api/advanced-rag/clear-caches', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showAdvancedRAGMessage('缓存清理成功', 'success');
                } else {
                    showAdvancedRAGMessage('缓存清理失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('缓存清理失败:', error);
                showAdvancedRAGMessage('缓存清理失败', 'error');
            }
        }

        // 可视化图谱
        function visualizeGraph() {
            showAdvancedRAGMessage('图谱可视化功能开发中...', 'info');
            // 这里可以集成图谱可视化库，如D3.js、vis.js等
        }

        // 测试向量化
        async function testVectorization() {
            const text = $('#vectorize_text').val().trim();
            const fusionStrategy = $('#fusion_strategy').val();
            const imagePath = $('#advanced_image_path').val().trim();

            if (!text) {
                showAdvancedRAGMessage('请输入测试文本', 'warning');
                return;
            }

            try {
                showAdvancedRAGMessage('正在执行向量化...', 'info');

                const response = await fetch('/api/advanced-rag/vectorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        image_path: imagePath || undefined,
                        fusion_strategy: fusionStrategy
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAdvancedRAGMessage('向量化成功', 'success');

                    // 显示向量化结果（不显示完整向量，只显示统计信息）
                    const resultInfo = {
                        vector_type: data.vector_type,
                        dimension: data.dimension,
                        fusion_strategy: data.fusion_strategy,
                        vector_preview: data.embedding.slice(0, 5).map(x => x.toFixed(4))
                    };

                    displayAdvancedRAGResult('向量化测试', resultInfo);
                } else {
                    showAdvancedRAGMessage('向量化失败: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('向量化测试失败:', error);
                showAdvancedRAGMessage('向量化测试失败', 'error');
            }
        }

        // 显示高级RAG消息
        function showAdvancedRAGMessage(message, type = 'info') {
            const colors = {
                'success': '#4CAF50',
                'error': '#f44336',
                'warning': '#ff9800',
                'info': '#2196F3'
            };

            const messageHtml = `
                <div style="background: ${colors[type]}; color: white; padding: 6px; margin: 3px 0; border-radius: 3px; font-size: 11px;">
                    ${message}
                </div>
            `;

            $('#advanced_rag_results').prepend(messageHtml);

            // 限制消息数量
            const messages = $('#advanced_rag_results').children();
            if (messages.length > 10) {
                messages.slice(10).remove();
            }
        }

        // 显示高级RAG结果
        function displayAdvancedRAGResult(operation, data) {
            const resultHtml = `
                <div style="border: 1px solid #ddd; padding: 6px; margin: 5px 0; border-radius: 3px; font-size: 10px; background: #f9f9f9;">
                    <div style="font-weight: bold; color: #333;">${operation} 结果:</div>
                    <pre style="margin: 3px 0; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;

            $('#advanced_rag_results').prepend(resultHtml);

            // 限制结果数量
            const results = $('#advanced_rag_results').children();
            if (results.length > 5) {
                results.slice(5).remove();
            }
        }

        // 更新高级RAG统计信息
        function updateAdvancedRAGStatistics(status) {
            if (!status) return;

            let statsHtml = '<div style="font-weight: bold;">高级RAG统计:</div>';

            if (status.processing_stats) {
                const stats = status.processing_stats;
                statsHtml += `
                    <div>文档处理: ${stats.documents_processed}</div>
                    <div>查询处理: ${stats.queries_processed}</div>
                    <div>推理请求: ${stats.reasoning_requests}</div>
                    <div>融合操作: ${stats.fusion_operations}</div>
                `;
            }

            if (status.knowledge_graph_stats) {
                const kgStats = status.knowledge_graph_stats;
                statsHtml += `
                    <div>图谱节点: ${kgStats.nodes}</div>
                    <div>图谱边: ${kgStats.edges}</div>
                `;
            }

            if (status.integration_status) {
                const integration = status.integration_status;
                statsHtml += `
                    <div>基础RAG: ${integration.basic_rag_available ? '✓' : '✗'}</div>
                    <div>多模态: ${integration.multimodal_available ? '✓' : '✗'}</div>
                `;
            }

            $('#advanced_rag_statistics').html(statsHtml);
        }

        // 页面加载完成后初始化
        $(document).ready(function() {
            initRAG();
            initAdvancedEmotionSystem();
            initMultimodalSystem();
            initVoiceEmotionSystem();
            initAdvancedRAGSystem();
        });
    </script>
</body>
</html>
