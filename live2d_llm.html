<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D AI 助手</title>
    <script src="./js/live2dcubismcore.min.js"></script>
    <script src="./js/live2d.min.js"></script>
    <script src="./js/pixi.min.js"></script>
    <script src="./js/cubism4.min.js"></script>
    <script src="./js/jquery-3.1.1.min.js"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-color: #FFFFFF;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.5s, background-image 0.5s;
        }
        #control {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 90vh;
            overflow-y: auto;
            width: 320px;
            z-index: 1000;
        }
        .section {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        #control label, #control input, #control select, #control button {
            margin: 5px 0;
            display: block;
        }
        #control input[type="text"], 
        #control input[type="url"], 
        #control input[type="search"], 
        #control select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #control button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #control button:hover {
            background: #45a049;
        }
        #control button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #text_talk {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }
        .model-config {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            align-items: center;
        }
        .chat-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .chat-input input {
            flex: 1;
        }
        .audio-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .tts-settings {
            margin-top: 10px;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        #audio-status {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .bg-option {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .bg-input-group {
            margin-top: 10px;
        }
        #bg_type {
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 10px;
        }
        .tab {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px 4px 0 0;
            background: #f5f5f5;
        }
        .tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #bg_image_preset {
            width: 100%;
            margin-bottom: 10px;
        }
        .dialog {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .dialog-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .secondary-button {
            background-color: #6c757d;
            color: white;
        }
        
        .dialog-actions {
            margin-top: 15px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="background"></div>
    <canvas id="canvas"></canvas>

    <div id="control">
        <div class="section">
            <div class="section-title">模型控制</div>
            <div class="model-selection">
                <label for="model_list">选择模型:</label>
                <select id="model_list">
                    <option value="March 7th">March 7th</option>
                    <option value="kei_vowels_pro">kei_vowels_pro</option>
                    <option value="Nova - F">Nova - F</option>
                    <option value="Hiyori">Hiyori</option>
                    <option value="pachan">pachan</option>
                    <option value="EVA RIN normal">EVA RIN normal</option>
                </select>
                <button id="update_model">更新模型</button>
                <button id="check_lfs" class="secondary-button">检查模型文件</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">语音设置</div>
            <div class="tts-settings">
                <select id="voice_selection">
                    <option value="21m00Tcm4TlvDq8ikWAM">chinese (中文)</option>
                    <option value="AZnzlk1XvdvUeBnXmlld">Endlish (英语)</option>
                </select>
                <div class="volume-control">
                    <label for="volume">音量:</label>
                    <input type="range" id="volume" min="0" max="1" step="0.1" value="0.7">
                    <span id="volume-value">70%</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Ollama 配置</div>
            <div class="model-config">
                <label for="llm_model">语言模型:</label>
                <select id="llm_model">
                    <option value="deepseek-r1:7b">deepseek-r1:7b</option>
                    <option value="qwen2:0.5b">Qwen2 0.5B</option>
                    <option value="llama2:7b">LLaMA2 7B</option>
                </select>
                
                <label for="temperature">温度:</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                
                <label for="top_p">Top P:</label>
                <input type="range" id="top_p" min="0" max="1" step="0.1" value="0.9">
            </div>
        </div>

        <div class="section">
            <div class="section-title">角色设定</div>
            <label for="role_prompt">角色设定:</label>
            <textarea id="role_prompt" rows="3" style="width: 100%">一个AI助手，会认真回答您的问题。</textarea>
        </div>

        <div class="section">
            <div class="section-title">对话</div>
            <div class="chat-container">
                <textarea id="text_talk" readonly placeholder="对话历史将显示在这里..."></textarea>
                <div class="chat-input">
                    <input type="text" id="user_input" placeholder="输入您的问题...">
                    <button id="send_message">发送</button>
                </div>
                <div class="audio-controls">
                    <button id="play_audio" disabled>播放语音</button>
                    <button id="stop_audio" disabled>停止语音</button>
                </div>
                <div id="audio-status"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">背景设置</div>
            
            <div class="tabs">
                <div class="tab active" data-tab="color">纯色背景</div>
                <div class="tab" data-tab="image">图片背景</div>
            </div>
            
            <div class="tab-content active" id="color-tab">
                <div class="bg-option">
                    <label for="bg_color">背景颜色:</label>
                    <input type="color" id="bg_color" value="#FFFFFF">
                </div>
                <button id="update_bg_color">更新背景颜色</button>
            </div>
            
            <div class="tab-content" id="image-tab">
                <select id="bg_image_preset">
                    <option value="">- 选择预设背景 -</option>
                    <option value="./backgrounds/classroom.jpg">教室</option>
                    <option value="./backgrounds/beach.jpg">海滩</option>
                    <option value="./backgrounds/forest.jpg">森林</option>
                    <option value="./backgrounds/space.jpg">太空</option>
                </select>
                
                <div class="bg-input-group">
                    <label for="bg_image_url">自定义背景图片URL:</label>
                    <input type="url" id="bg_image_url" placeholder="输入图片URL...">
                </div>
                <button id="update_bg_image">更新背景图片</button>
            </div>
        </div>
    </div>

    <!-- 添加LFS检查结果弹窗 -->
    <div id="lfs_dialog" class="dialog" style="display: none;">
        <div class="dialog-content">
            <span class="close-btn">&times;</span>
            <h3>模型文件检查结果</h3>
            <div id="lfs_check_result"></div>
            <div class="dialog-actions">
                <button id="close_lfs_dialog">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // Live2D 模型配置
        const modelPaths = {
            'March 7th': './models/March 7th/March 7th.model3.json',
            'kei_vowels_pro': './models/kei_vowels_pro/kei_vowels_pro.model3.json',
            'Nova - F': './models/Nova - F/Nova - F.model3.json',
            'Hiyori': './models/Hiyori/Hiyori.model3.json',
            'pachan': './models/pachan/pachan.model3.json',
            'EVA RIN normal': './models/EVA RIN normal/EVA RIN normal.model3.json'
        };

        // 添加模型类型映射
        const modelTypes = {
            'March 7th': 'cubism4',
            'kei_vowels_pro': 'cubism4',
            'Nova - F': 'cubism4',
            'Hiyori': 'cubism4',
            'pachan': 'cubism4',
            'EVA RIN normal': 'cubism4'
        };

        let currentModel;
        let app;
        let chatHistory = [];
        let currentAudio = null;
        let lastAudioUrl = null;

        // 初始化模型选择下拉框
        const $modelSelect = $("#model_list");
        Object.keys(modelPaths).forEach(model => {
            $modelSelect.append($("<option>").attr("value", model).text(model));
        });

        // 音频控制函数
        function updateAudioStatus(message) {
            document.getElementById('audio-status').textContent = message;
        }

        function enableAudioControls(enabled = true) {
            document.getElementById('play_audio').disabled = !enabled;
            document.getElementById('stop_audio').disabled = !enabled || !currentAudio;
        }

        function playAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            if (lastAudioUrl) {
                currentAudio = new Audio(lastAudioUrl);
                currentAudio.volume = parseFloat(document.getElementById('volume').value);
                
                currentAudio.onplay = () => {
                    enableAudioControls(true);
                    document.getElementById('play_audio').disabled = true;
                    document.getElementById('stop_audio').disabled = false;
                    updateAudioStatus('正在播放...');
                };
                
                currentAudio.onended = () => {
                    enableAudioControls(true);
                    document.getElementById('stop_audio').disabled = true;
                    updateAudioStatus('播放完成');
                };

                currentAudio.onerror = () => {
                    updateAudioStatus('音频播放失败');
                    enableAudioControls(false);
                };
                
                currentAudio.play().catch(error => {
                    console.error('播放音频失败:', error);
                    updateAudioStatus('播放失败: ' + error.message);
                });
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                document.getElementById('play_audio').disabled = false;
                document.getElementById('stop_audio').disabled = true;
                updateAudioStatus('已停止播放');
            }
        }

        // 背景控制函数
        function updateBackgroundColor(color) {
            document.getElementById('background').style.backgroundColor = color;
            document.getElementById('background').style.backgroundImage = 'none';
        }

        function updateBackgroundImage(url) {
            if (url) {
                document.getElementById('background').style.backgroundImage = `url('${url}')`;
            } else {
                alert('请输入有效的图片URL');
            }
        }

        // 加载Live2D模型
        async function loadModel(modelName) {
            if (!app) {
                // 修正：确保画布背景透明
                app = new PIXI.Application({
                    view: document.getElementById("canvas"),
                    autoStart: true,
                    resizeTo: window,
                    transparent: true,
                    backgroundAlpha: 0
                });
            }

            if (currentModel) {
                app.stage.removeChild(currentModel);
            }
            
            try {
                // 获取模型路径
                const modelPath = modelPaths[modelName];
                console.log("准备加载模型:", modelPath);
                
                // 检查模型类型
                let modelType = modelTypes[modelName] || 'cubism4';
                const isModelCubism2 = modelPath.endsWith('.model.json');
                const isModelCubism4 = modelPath.endsWith('.model3.json');
                
                // 根据文件扩展名确定实际类型
                if (isModelCubism2) modelType = 'cubism2';
                if (isModelCubism4) modelType = 'cubism4';
                
                console.log("模型类型:", modelType);
                
                // 根据类型选择加载方法
                let model;
                if (modelType === 'cubism2') {
                    // 使用Cubism 2引擎加载
                    console.log("使用Cubism 2引擎加载模型");
                    
                    // 检查是否加载了Cubism 2引擎
                    if (typeof Live2D === 'undefined') {
                        throw new Error("Cubism 2引擎未加载，无法加载Cubism 2模型");
                    }
                    
                    // 这里实现Cubism 2模型加载逻辑
                    // 注意：这需要完整的Cubism 2加载实现
                    alert("Cubism 2模型加载尚未完全实现，请使用Cubism 4模型");
                    throw new Error("Cubism 2模型加载尚未实现");
                } else {
                    // 使用Cubism 4引擎加载
                    console.log("使用Cubism 4引擎加载模型");
                    model = await PIXI.live2d.Live2DModel.from(modelPath);
                }
                
                app.stage.addChild(model);
                
                const scale = Math.min(innerWidth / model.width, innerHeight / model.height);
                model.scale.set(scale);
                model.y = innerHeight * 0.1;
                model.x = innerWidth / 2;
                
                currentModel = model;
                
                // 记录加载成功
                console.log("模型加载成功:", modelName);
                return model;
            } catch (error) {
                console.error("加载模型失败:", error);
                
                // 记录详细错误信息
                if (error.message === "Invalid moc data") {
                    console.error("可能原因：模型格式与引擎不兼容，或模型文件损坏");
                    
                    // 发送错误信息到服务器进行记录
                    try {
                        await fetch('/api/log_model_error', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model_path: modelPaths[modelName],
                                error: error.message,
                                stack: error.stack
                            })
                        });
                    } catch (logError) {
                        console.error("无法记录错误:", logError);
                    }
                    
                    // 提示用户
                    alert(`加载模型失败：模型格式可能与引擎不兼容\n请检查 ${modelName} 是否为Cubism 4格式的模型`);
                } else {
                    alert(`加载模型失败：${error.message}`);
                }
            }
        }

        // 发送消息并处理响应
        async function sendMessage(message) {
            const model = $("#llm_model").val();
            const temperature = parseFloat($("#temperature").val());
            const top_p = parseFloat($("#top_p").val());
            const rolePrompt = $("#role_prompt").val();
            const voiceId = $("#voice_selection").val();

            // 禁用发送按钮，显示加载状态
            $("#send_message").prop('disabled', true);
            $("#text_talk").val($("#text_talk").val() + '\n用户: ' + message + '\n助手: ');

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: `${rolePrompt}\n\n用户: ${message}\n助手: `,
                        model_name: model,
                        temperature: temperature,
                        top_p: top_p,
                        voice_id: voiceId
                    })
                });

                if (!response.ok) {
                    throw new Error('API请求失败');
                }

                const reader = response.body.getReader();
                let fullResponse = '';
                const textArea = document.getElementById('text_talk');

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const data = JSON.parse(line);
                                if (data.chunk) {
                                    fullResponse += data.chunk;
                                    textArea.value = textArea.value.substring(0, textArea.value.lastIndexOf('助手: ') + 4) + fullResponse;
                                    textArea.scrollTop = textArea.scrollHeight;
                                }
                                if (data.done && data.audio_url) {
                                    console.log('收到音频URL:', data.audio_url);
                                    lastAudioUrl = data.audio_url;
                                    enableAudioControls(true);
                                    updateAudioStatus('音频已准备就绪');
                                    playAudio(); // 自动播放新生成的音频
                                }
                            } catch (e) {
                                console.error('解析响应失败:', e);
                            }
                        }
                    }
                }

                chatHistory.push({role: 'user', content: message});
                chatHistory.push({role: 'assistant', content: fullResponse});
                
                updateChatDisplay();
            } catch (error) {
                console.error('发送消息失败:', error);
                alert('发送消息失败，请检查网络连接和服务器状态');
            } finally {
                // 恢复发送按钮
                $("#send_message").prop('disabled', false);
            }
        }

        // 更新对话历史显示
        function updateChatDisplay() {
            const display = chatHistory.map(msg => 
                `${msg.role === 'user' ? '用户' : '助手'}: ${msg.content}`
            ).join('\n\n');
            $("#text_talk").val(display);
        }

        // 事件监听器
        $(document).ready(function() {
            // 加载可用模型列表
            loadAvailableModels();
            
            // 初始模型检查与加载
            checkAndLoadModel($modelSelect.val());

            // 更新模型按钮
            $("#update_model").click(function() {
                checkAndLoadModel($modelSelect.val());
            });

            // 音量控制
            $("#volume").on('input', function() {
                const volume = parseFloat(this.value);
                $("#volume-value").text(Math.round(volume * 100) + '%');
                if (currentAudio) {
                    currentAudio.volume = volume;
                }
            });

            // 音频控制按钮
            $("#play_audio").click(playAudio);
            $("#stop_audio").click(stopAudio);

            // 发送消息按钮
            $("#send_message").click(function() {
                const message = $("#user_input").val().trim();
                if (message) {
                    sendMessage(message);
                    $("#user_input").val('');
                }
            });

            // 输入框回车发送
            $("#user_input").keypress(function(e) {
                if (e.which == 13 && !e.shiftKey) {
                    $("#send_message").click();
                    e.preventDefault();
                }
            });

            // 标签切换
            $(".tab").click(function() {
                $(".tab").removeClass("active");
                $(this).addClass("active");
                
                const tabId = $(this).data("tab");
                $(".tab-content").removeClass("active");
                
                if (tabId === "color") {
                    $("#color-tab").addClass("active");
                } else if (tabId === "image") {
                    $("#image-tab").addClass("active");
                }
            });

            // 更新背景颜色
            $("#update_bg_color").click(function() {
                const color = $("#bg_color").val();
                updateBackgroundColor(color);
            });

            // 更新背景图片
            $("#update_bg_image").click(function() {
                const customUrl = $("#bg_image_url").val().trim();
                const presetUrl = $("#bg_image_preset").val();
                
                const imageUrl = customUrl || presetUrl;
                if (imageUrl) {
                    updateBackgroundImage(imageUrl);
                } else {
                    alert("请选择预设图片或输入自定义图片URL");
                }
            });

            // 预设背景选择变化时自动更新
            $("#bg_image_preset").change(function() {
                const presetUrl = $(this).val();
                if (presetUrl) {
                    updateBackgroundImage(presetUrl);
                    $("#bg_image_url").val(''); // 清空自定义URL
                }
            });

            // 窗口大小改变时调整模型大小
            window.addEventListener('resize', function() {
                if (currentModel) {
                    const scale = Math.min(innerWidth / currentModel.width, innerHeight / currentModel.height);
                    currentModel.scale.set(scale);
                    currentModel.y = innerHeight * 0.1;
                    currentModel.x = innerWidth / 2;
                }
            });

            // 确保音频状态显示区域初始化
            updateAudioStatus('等待生成语音...');
        });
        
        // 加载可用模型列表
        async function loadAvailableModels() {
            try {
                const response = await fetch('/get_model_list');
                if (!response.ok) {
                    throw new Error('获取模型列表失败');
                }
                
                const models = await response.json();
                console.log("服务器返回模型列表:", models);
                
                // 更新模型选择下拉框
                const $modelSelect = $("#model_list");
                $modelSelect.empty();
                
                models.forEach(model => {
                    modelPaths[model.name] = model.path;
                    modelTypes[model.name] = model.type;
                    $modelSelect.append($("<option>").attr("value", model.name).text(model.name));
                });
                
                // 如果没有模型，显示提示
                if (models.length === 0) {
                    alert("没有找到可用的Live2D模型，请确保模型文件夹存在并包含有效模型");
                }
            } catch (error) {
                console.error('加载模型列表失败:', error);
                alert('无法加载模型列表，请检查服务器状态');
            }
        }
        
        // 检查并加载模型
        async function checkAndLoadModel(modelName) {
            try {
                const modelPath = modelPaths[modelName];
                if (!modelPath) {
                    alert(`找不到模型 ${modelName} 的路径配置`);
                    return;
                }
                
                console.log(`开始验证模型: ${modelName} (${modelPath})`);
                
                // 验证模型文件
                const verifyResponse = await fetch(`/api/verify_model_files/${modelPath}`);
                const verifyResult = await verifyResponse.json();
                
                console.log("模型验证结果:", verifyResult);
                
                if (!verifyResult.is_valid) {
                    let missingFiles = verifyResult.missing_files.join("\n- ");
                    alert(`模型 ${modelName} 缺少必要文件:\n- ${missingFiles}`);
                    return;
                }
                
                if (verifyResult.model_type === "cubism2" && modelTypes[modelName] === "cubism4") {
                    alert(`警告: ${modelName} 是Cubism 2格式，但当前配置为使用Cubism 4引擎加载`);
                }
                
                if (verifyResult.model_type === "cubism4" && modelTypes[modelName] === "cubism2") {
                    alert(`警告: ${modelName} 是Cubism 4格式，但当前配置为使用Cubism 2引擎加载`);
                }
                
                // 加载模型
                console.log(`验证通过，开始加载模型: ${modelName}`);
                loadModel(modelName);
                
            } catch (error) {
                console.error('验证模型失败:', error);
                alert(`验证模型 ${modelName} 时出错: ${error.message}`);
            }
        }

        // 检查LFS指针
        async function checkLFSPointers() {
            try {
                const response = await fetch('/api/check_lfs_pointers');
                if (!response.ok) {
                    throw new Error('检查LFS指针失败');
                }
                
                const result = await response.json();
                console.log("LFS检查结果:", result);
                
                let html = '';
                
                if (result.lfs_pointers_found) {
                    html += `<div class="alert alert-danger">
                        <p><strong>发现Git LFS指针文件!</strong></p>
                        <p>您的模型文件是Git LFS指针，而不是实际的模型数据，这就是模型无法加载的原因。</p>
                    </div>`;
                    
                    html += `<h4>受影响的文件：</h4><ul>`;
                    result.files.forEach(file => {
                        html += `<li>${file.path} (当前大小: ${file.size} 字节, 预期大小: ${file.expected_size})</li>`;
                    });
                    html += `</ul>`;
                    
                    html += `<h4>解决方案：</h4>`;
                    
                    if (result.git_lfs_installed) {
                        html += `<p>1. Git LFS已安装，请运行以下命令拉取实际的模型文件：</p>
                        <pre>cd ${result.repo_path}
git lfs pull</pre>`;
                    } else {
                        html += `<p>1. 您需要安装Git LFS并拉取模型文件：</p>
                        <pre># 下载并安装Git LFS: https://git-lfs.github.com/
# 然后运行:
cd ${result.repo_path}
git lfs install
git lfs pull</pre>`;
                    }
                    
                    html += `<p>2. 或者，您可以从Live2D官方网站下载示例模型：</p>
                    <p><a href="https://www.live2d.com/en/download/sample-data/" target="_blank">https://www.live2d.com/en/download/sample-data/</a></p>`;
                } else {
                    html += `<div class="alert alert-success">
                        <p><strong>模型文件检查正常</strong></p>
                        <p>未发现Git LFS指针问题。请检查其他可能导致模型加载失败的因素：</p>
                        <ul>
                            <li>模型格式与引擎版本是否匹配 (Cubism 2 vs Cubism 4)</li>
                            <li>模型文件是否完整且未损坏</li>
                            <li>模型配置文件中的路径是否正确</li>
                        </ul>
                    </div>`;
                }
                
                // 显示结果
                document.getElementById('lfs_check_result').innerHTML = html;
                document.getElementById('lfs_dialog').style.display = 'block';
                
            } catch (error) {
                console.error('检查LFS指针失败:', error);
                alert(`检查模型文件失败: ${error.message}`);
            }
        }
        
        // 处理对话框关闭
        document.querySelector('.close-btn').addEventListener('click', function() {
            document.getElementById('lfs_dialog').style.display = 'none';
        });
        
        document.getElementById('close_lfs_dialog').addEventListener('click', function() {
            document.getElementById('lfs_dialog').style.display = 'none';
        });
        
        // 绑定检查按钮事件
        document.getElementById('check_lfs').addEventListener('click', checkLFSPointers);
    </script>
</body>
</html>
